<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HazeNote Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        dark: '#0a0a0a',
                        teal: '#85B9C9',
                        danger: '#FF4A4A',
                    },
                    fontFamily: {
                        sans: ['Urbanist', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'], // 新增衬线体用于艺术感
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(255, 255, 255, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { 
            background-color: #000000; 
            color: white; 
            font-family: 'Urbanist', sans-serif;
            overscroll-behavior: none; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 沉浸式背景 */
        .blob-bg {
            position: absolute; border-radius: 50%; filter: blur(100px); z-index: 0; opacity: 0.3; pointer-events: none;
        }

        /* 搜索框动画 */
        .search-bar-enter { animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .search-bar-exit { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideDown { from { width: 48px; opacity: 0.5; } to { width: 100%; opacity: 1; } }
        @keyframes slideUp { from { width: 100%; opacity: 1; } to { width: 48px; opacity: 0.5; } }

        /* ================= 艺术画廊布局核心 (Bento Grid) ================= */
        #noteList {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 两列布局 */
            grid-auto-rows: 180px; /* 基础高度 */
            grid-auto-flow: dense; /* 关键：自动填补空隙 */
            gap: 12px;
            padding-bottom: 120px;
        }

        /* 卡片基础样式 */
        .note-card {
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            transition: transform 0.2s;
            background-color: #111;
            touch-action: pan-y;
        }
        .note-card:active { transform: scale(0.98); }

        /* 布局变体 */
        .card-square { grid-column: span 1; grid-row: span 1; }
        .card-tall   { grid-column: span 1; grid-row: span 2; }
        .card-wide   { grid-column: span 2; grid-row: span 1; }
        .card-big    { grid-column: span 2; grid-row: span 2; }

        /* 背景图片处理 */
        .card-bg-img {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.6; z-index: 0;
            transition: transform 0.5s ease;
        }
        /* 渐变遮罩，保证文字可见 */
        .card-overlay {
            position: absolute; inset: 0; z-index: 1;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 10%, rgba(0,0,0,0.2) 60%, rgba(0,0,0,0.1) 100%);
            backdrop-filter: blur(0px); /* 默认微弱模糊 */
        }
        
        .note-content-layer { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 16px; }

        /* AssistiveTouch */
        #floatingContainer { position: fixed; z-index: 999; touch-action: none; }
        .assistive-btn { 
            box-shadow: 0 10px 40px -10px rgba(255,255,255,0.3);
            transition: transform 0.1s; 
        }
        .assistive-btn.dragging { transform: scale(1.1); opacity: 0.9; }

        /* 隐藏截图区 */
        #shareCaptureArea {
            position: fixed; top: -9999px; left: -9999px; width: 1080px; height: 1920px;
            background: #000; display: flex; flex-direction: column; padding: 100px;
            font-family: 'Urbanist', sans-serif;
        }

        textarea:focus { outline: none; }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-black text-white">

    <div class="blob-bg w-full h-[500px] bg-teal/10 top-[-100px] left-0"></div>
    <div class="blob-bg w-80 h-80 bg-purple/20 bottom-0 right-0"></div>

    <div id="mainApp" class="w-full max-w-md h-screen flex flex-col relative z-10 bg-black/20 backdrop-blur-sm">
        
        <header class="px-5 pt-14 pb-4 z-20 pointer-events-auto flex justify-between items-center">
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-teal to-purple p-[1.5px] shadow-glow">
                <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Art" class="w-full h-full rounded-full bg-black">
            </div>

            <div id="searchContainer" class="relative flex justify-end items-center h-10 transition-all duration-300 w-10">
                <input id="searchInput" type="text" placeholder="Search..." class="absolute right-0 w-full h-full bg-dark/80 border border-white/10 rounded-full px-10 text-sm text-white outline-none opacity-0 pointer-events-none transition-all" oninput="handleSearch(this.value)" onblur="closeSearch()">
                <button onclick="toggleSearch()" class="absolute right-0 w-10 h-10 flex items-center justify-center text-white z-10">
                    <i class="fa-solid fa-magnifying-glass text-sm"></i>
                </button>
            </div>
        </header>

        <div class="px-6 mb-4 flex gap-4 text-[10px] font-bold tracking-widest text-gray-500 uppercase">
            <span id="noteCount">0 ART PIECES</span>
            <span id="pinCountBadge" class="hidden text-teal">PINNED</span>
        </div>

        <main id="noteList" class="px-4 overflow-y-auto no-scrollbar touch-pan-y">
            </main>

        <div id="floatingContainer" style="top: 85%; left: 82%;">
            <div id="assistiveMenu" class="absolute bottom-20 right-0 bg-[#1A1A1A]/90 backdrop-blur-xl border border-white/10 rounded-2xl p-2 w-40 shadow-2xl hidden flex-col gap-1 origin-bottom-right z-50">
                <button onclick="changeView('grid')" class="menu-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 transition w-full text-left">
                    <i class="fa-solid fa-border-all w-4"></i> <span class="text-xs font-bold">Grid</span>
                </button>
                <button onclick="changeView('list')" class="menu-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 transition w-full text-left">
                    <i class="fa-solid fa-bars w-4"></i> <span class="text-xs font-bold">List</span>
                </button>
                <div class="h-px bg-white/10 my-1"></div>
                <button onclick="exportData()" class="menu-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 transition w-full text-left">
                    <i class="fa-solid fa-download w-4"></i> <span class="text-xs font-bold">Backup</span>
                </button>
                <button onclick="triggerImport()" class="menu-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 transition w-full text-left">
                    <i class="fa-solid fa-upload w-4"></i> <span class="text-xs font-bold">Restore</span>
                </button>
            </div>

            <div class="relative w-14 h-14 flex items-center justify-center">
                <div id="assistiveBtn" class="assistive-btn w-14 h-14 rounded-full bg-white text-black text-xl flex items-center justify-center z-10 cursor-pointer">
                    <i class="fa-solid fa-plus pointer-events-none"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col opacity-0 transition-opacity duration-300">
        <div class="px-6 pt-14 pb-4 flex justify-between items-center">
            <button onclick="closeModal()" class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center text-white hover:bg-white/10">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <span class="text-xs font-bold text-gray-500 tracking-[0.2em]">CANVAS</span>
            <button onclick="saveNote()" class="w-10 h-10 rounded-full bg-white text-black flex items-center justify-center font-bold hover:scale-105 transition">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>
        <div class="flex-1 px-8 pt-4">
            <textarea id="noteInput" class="w-full h-full bg-transparent text-white text-2xl font-serif italic placeholder-gray-800 resize-none leading-relaxed outline-none" placeholder="Draft your masterpiece..."></textarea>
        </div>
        <div class="px-8 pb-10 flex justify-center">
            <button id="deleteBtn" onclick="confirmDelete(state.editingId)" class="hidden text-danger text-xs font-bold tracking-widest border border-danger/30 px-6 py-3 rounded-full hover:bg-danger hover:text-white transition">
                DISSOLVE
            </button>
        </div>
    </div>

    <div id="shareCaptureArea">
        <img id="shareBgImg" src="" class="absolute inset-0 w-full h-full object-cover opacity-50 grayscale contrast-125">
        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
        
        <div class="relative z-10 flex-1 flex flex-col justify-center items-center text-center px-10">
            <i class="fa-solid fa-quote-left text-4xl text-teal mb-10 opacity-80"></i>
            <p id="shareTextContent" class="text-[70px] font-serif italic leading-tight text-white mb-10 drop-shadow-2xl"></p>
            <div class="w-20 h-1 bg-white/50 mb-10"></div>
            <p id="shareDateContent" class="text-[30px] text-gray-400 font-sans uppercase tracking-[0.3em]"></p>
        </div>
        
        <div class="relative z-10 flex justify-between items-end border-t border-white/20 pt-10 w-full">
            <div>
                <h1 class="text-[40px] font-bold text-white tracking-tighter">HazeNote</h1>
                <p class="text-[24px] text-gray-500 font-serif italic">Curated Thoughts.</p>
            </div>
            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center">
                <div class="w-2 h-2 bg-black rounded-full"></div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">

    <script>
        const CONFIG = { PIN_LIMIT: 3, LONG_PRESS_MS: 500 };
        let state = {
            notes: [],
            viewMode: localStorage.getItem('haze_view_mode') || 'grid', // 'grid' (Bento) or 'list'
            searchQuery: '',
            isSearchOpen: false,
            editingId: null
        };

        window.onload = () => {
            loadNotes();
            initDraggableButton();
        };

        function loadNotes() {
            const saved = localStorage.getItem('haze_notes_v4_art');
            if (saved) state.notes = JSON.parse(saved);
            renderNotes();
        }

        function saveToLocal() {
            localStorage.setItem('haze_notes_v4_art', JSON.stringify(state.notes));
            renderNotes();
        }

        // ========== Render Logic (The Art Gallery) ==========
        function renderNotes() {
            const list = document.getElementById('noteList');
            let displayNotes = state.notes.filter(n => n.content.toLowerCase().includes(state.searchQuery));
            
            // 排序: Pin First
            displayNotes.sort((a, b) => (b.isPinned === a.isPinned) ? 0 : a.isPinned ? -1 : 1);

            document.getElementById('noteCount').innerText = `${displayNotes.length} ART PIECES`;
            document.getElementById('pinCountBadge').className = state.notes.some(n=>n.isPinned) ? 'text-teal' : 'hidden';

            list.innerHTML = '';
            
            if (state.viewMode === 'list') {
                list.style.display = 'flex';
                list.style.flexDirection = 'column';
                list.style.gap = '1rem';
            } else {
                list.style.display = 'grid';
            }

            if (displayNotes.length === 0) {
                list.innerHTML = `<div class="col-span-2 text-center mt-32 text-gray-700 font-serif italic text-xl">The canvas is empty.</div>`;
                return;
            }

            displayNotes.forEach((note, index) => {
                // 如果没有图片，分配一个随机种子
                if(!note.imgSeed) {
                    note.imgSeed = Math.floor(Math.random() * 1000);
                    saveToLocal(); // 存下来，保证图片不变
                }
                
                // 布局算法：根据内容长度和随机性决定卡片形状 (Bento Logic)
                let shapeClass = 'card-square'; 
                if (state.viewMode === 'grid') {
                    const len = note.content.length;
                    if (note.isPinned) shapeClass = 'card-wide'; // 置顶默认宽卡片
                    else if (len > 100) shapeClass = 'card-tall'; // 内容多变高
                    else if (index % 5 === 0) shapeClass = 'card-big'; // 偶尔出现大卡片
                    else if (index % 3 === 0) shapeClass = 'card-wide';
                } else {
                    shapeClass = 'w-full h-[120px]'; // List mode
                }

                list.innerHTML += createNoteCard(note, shapeClass);
            });
        }

        function createNoteCard(note, shapeClass) {
            const dateStr = new Date(note.date).toLocaleDateString('en', { month: 'short', day: 'numeric' });
            
            // 使用 Picsum 获取高质量抽象/自然图片，加上 blur 参数增加艺术感，grayscale 降低色彩干扰
            // 这里使用 picsum.photos/seed/{seed}/{width}/{height} 
            const imgUrl = `https://picsum.photos/seed/${note.imgSeed}/400/600?grayscale&blur=2`;
            
            // 如果是 list 模式，不需要复杂的 Grid class
            const containerClass = state.viewMode === 'list' 
                ? `note-card w-full min-h-[100px] mb-4`
                : `note-card ${shapeClass}`;

            return `
            <div class="${containerClass}" onclick="openNote('${note.id}')">
                <img src="${imgUrl}" class="card-bg-img">
                <div class="card-overlay"></div>
                
                <div class="note-content-layer">
                    <div class="flex justify-between items-start">
                        ${note.isPinned ? '<i class="fa-solid fa-thumbtack text-teal text-xs z-20"></i>' : '<div></div>'}
                        <div class="flex gap-3 z-20">
                            <button onclick="event.stopPropagation(); togglePin('${note.id}')" class="text-white/30 hover:text-teal transition"><i class="fa-solid fa-thumbtack"></i></button>
                            <button onclick="event.stopPropagation(); shareNote('${note.id}')" class="text-white/30 hover:text-white transition"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                        </div>
                    </div>

                    <div>
                        <p class="text-gray-100 font-medium leading-relaxed ${state.viewMode === 'grid' && shapeClass.includes('big') ? 'text-2xl font-serif italic' : 'text-base'} line-clamp-3 drop-shadow-md">
                            ${note.content}
                        </p>
                        <div class="mt-3 flex justify-between items-end border-t border-white/10 pt-2">
                            <span class="text-[10px] font-bold tracking-widest text-gray-400 uppercase">Haze.${note.imgSeed}</span>
                            <span class="text-[10px] font-mono text-gray-500">${dateStr}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // ========== Edit & Interaction ==========
        function openNote(id = null) {
            const modal = document.getElementById('noteModal');
            const input = document.getElementById('noteInput');
            const deleteBtn = document.getElementById('deleteBtn');
            
            modal.classList.remove('hidden');
            // Fade in
            requestAnimationFrame(() => modal.classList.remove('opacity-0'));

            if (id) {
                const note = state.notes.find(n => n.id === id);
                state.editingId = id;
                input.value = note.content;
                deleteBtn.classList.remove('hidden');
            } else {
                state.editingId = null;
                input.value = '';
                deleteBtn.classList.add('hidden');
            }
            setTimeout(() => input.focus(), 100);
        }

        function closeModal() {
            const modal = document.getElementById('noteModal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function saveNote() {
            const content = document.getElementById('noteInput').value.trim();
            if (!content) return closeModal();

            if (state.editingId) {
                const note = state.notes.find(n => n.id === state.editingId);
                if (note) { note.content = content; note.date = new Date().toISOString(); }
            } else {
                state.notes.unshift({ 
                    id: Date.now().toString(), 
                    content, 
                    date: new Date().toISOString(), 
                    isPinned: false,
                    imgSeed: Math.floor(Math.random() * 1000) // New Random Art
                });
            }
            saveToLocal(); closeModal();
        }

        function togglePin(id) {
            const note = state.notes.find(n => n.id === id);
            if(note) { note.isPinned = !note.isPinned; saveToLocal(); }
        }

        function confirmDelete(id) {
            if(confirm("Destroy this piece?")) {
                state.notes = state.notes.filter(n => n.id !== id);
                saveToLocal(); closeModal();
            }
        }

        // ========== Native Share Logic (The Upgrade) ==========
        async function shareNote(id) {
            const note = state.notes.find(n => n.id === id);
            if(!note) return;

            const capture = document.getElementById('shareCaptureArea');
            const bgImg = document.getElementById('shareBgImg');
            
            // 设置分享图内容
            document.getElementById('shareTextContent').innerText = note.content;
            document.getElementById('shareDateContent').innerText = new Date(note.date).toLocaleDateString('en');
            // 使用同样的高清图作为分享背景
            bgImg.src = `https://picsum.photos/seed/${note.imgSeed}/1080/1920?grayscale&blur=2`;
            
            // 等待图片加载完成再截图（防止黑屏）
            await new Promise(r => setTimeout(r, 500)); 

            try {
                const canvas = await html2canvas(capture, { 
                    useCORS: true, 
                    scale: 1, // High Res
                    backgroundColor: '#000' 
                });

                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "HazeNote_Art.png", { type: "image/png" });

                    // 1. 尝试调用原生分享 (Mobile)
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'HazeNote Art',
                                text: note.content
                            });
                        } catch (err) {
                            console.log('Share cancelled or failed', err);
                        }
                    } else {
                        // 2. 降级方案：下载图片 (Desktop)
                        const link = document.createElement('a');
                        link.download = `HazeNote_${Date.now()}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                        alert("Saved to gallery (Native sharing not supported on this device)");
                    }
                }, 'image/png');
            } catch (e) {
                alert("Creation failed. Try again.");
                console.error(e);
            }
        }

        // ========== Search & View ==========
        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            const input = document.getElementById('searchInput');
            
            if(input.classList.contains('opacity-0')) {
                input.classList.remove('opacity-0', 'pointer-events-none');
                input.classList.add('w-full');
                input.focus();
            } else {
                closeSearch();
            }
        }
        function closeSearch() {
            const input = document.getElementById('searchInput');
            if(input.value === '') {
                input.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        function handleSearch(val) { state.searchQuery = val.toLowerCase(); renderNotes(); }
        function changeView(mode) { state.viewMode = mode; saveToLocal(); document.getElementById('assistiveMenu').classList.add('hidden'); renderNotes(); }

        // ========== FAB Logic ==========
        function initDraggableButton() {
            const btn = document.getElementById('assistiveBtn');
            const menu = document.getElementById('assistiveMenu');
            let timer;
            
            btn.addEventListener('click', () => {
                if(menu.classList.contains('hidden')) openNote(); // Click -> New Note
                else menu.classList.add('hidden');
            });

            // Long Press for Menu
            btn.addEventListener('touchstart', () => {
                timer = setTimeout(() => {
                    navigator.vibrate?.(50);
                    menu.classList.remove('hidden');
                }, CONFIG.LONG_PRESS_MS);
            });
            btn.addEventListener('touchend', () => clearTimeout(timer));
        }
        
        // Import/Export
        function exportData() {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.notes));
            a.download = `HazeGallery_${Date.now()}.json`; a.click();
        }
        function triggerImport() { document.getElementById('fileInput').click(); }
    </script>
</body>
</html>
