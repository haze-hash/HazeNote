<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazeNote V3.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        dark: '#111111',
                        teal: '#85B9C9',
                        peach: '#FFBE9D',
                        purple: '#A29BFE',
                        orange: '#FF6B4A',
                        danger: '#FF4A4A',
                    },
                    fontFamily: {
                        sans: ['Urbanist', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { 
            background-color: #000000; 
            color: white; 
            font-family: 'Urbanist', sans-serif;
            overscroll-behavior: none; 
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ï¼Œä¼˜åŒ–æ‹–æ‹½ä½“éªŒ */
            -webkit-user-select: none;
            touch-action: none; /* å…¨å±€æ¥ç®¡è§¦æ‘¸ï¼Œé˜²æ­¢æ»šåŠ¨å†²çª */
        }
        
        /* å…è®¸åˆ—è¡¨åŒºåŸŸæ»šåŠ¨ */
        #noteList { touch-action: pan-y; }
        #noteInput { touch-action: auto; user-select: auto; -webkit-user-select: auto; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* èƒŒæ™¯å…‰æ™• */
        .blob-bg {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: 0;
            opacity: 0.4;
            pointer-events: none;
        }

        /* æœç´¢æ¡†åŠ¨ç”» */
        .search-bar-enter { animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .search-bar-exit { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideDown { from { height: 0; opacity: 0; margin-bottom: 0; } to { height: 50px; opacity: 1; margin-bottom: 20px; } }
        @keyframes slideUp { from { height: 50px; opacity: 1; margin-bottom: 20px; } to { height: 0; opacity: 0; margin-bottom: 0; } }

        /* æ»‘åŠ¨æ“ä½œæ ·å¼ */
        .note-container {
            position: relative;
            overflow: hidden;
            border-radius: 32px;
            margin-bottom: 1rem;
            touch-action: pan-y;
        }
        .note-card-content {
            position: relative;
            z-index: 10;
            background: #111111;
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .note-actions {
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 100%;
            display: flex; justify-content: flex-end; align-items: center;
            padding-right: 20px; gap: 12px;
            background: #1a1a1a; z-index: 1;
            border-radius: 32px;
        }
        
        /* --- AssistiveTouch æ ¸å¿ƒæ ·å¼ --- */
        #floatingContainer {
            position: fixed;
            z-index: 999;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼Œå®Œå…¨ç”±JSæ¥ç®¡æ‹–æ‹½ */
        }

        /* å‘¼å¸ç¯æ•ˆæœ */
        @keyframes breathe {
            0% { box-shadow: 0 0 0 0 rgba(133, 185, 201, 0.4); }
            50% { box-shadow: 0 0 20px 4px rgba(133, 185, 201, 0.6); }
            100% { box-shadow: 0 0 0 0 rgba(133, 185, 201, 0.4); }
        }
        
        .assistive-btn {
            animation: breathe 3s infinite ease-in-out;
            transition: transform 0.1s;
        }
        
        /* æ‹–æ‹½æ—¶ç¨å¾®æ”¾å¤§ */
        .assistive-btn.dragging {
            animation: none;
            transform: scale(1.1);
            opacity: 0.9;
        }

        /* è¿›åº¦åœ†ç¯ */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear; /* é»˜è®¤å¿«é€Ÿé‡ç½® */
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* é•¿æŒ‰æ—¶çš„åŠ¨ç”»ç±»ï¼šè¦†ç›–ä¸Šé¢çš„ transitionï¼Œå˜æˆ3ç§’çº¿æ€§ */
        .ring-filling {
            transition: stroke-dashoffset 3s linear !important;
            stroke-dashoffset: 0 !important;
        }

        /* èœå•å¼¹çª— */
        .menu-pop { 
            animation: menuPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; 
        }
        @keyframes menuPop { 
            from { opacity: 0; transform: scale(0.5); } 
            to { opacity: 1; transform: scale(1); } 
        }

        /* Pinned Style */
        .pinned-glow { box-shadow: 0 0 0 2px #85B9C9, 0 0 20px rgba(133, 185, 201, 0.3); }

        textarea:focus { outline: none; }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-black text-white">

    <div class="blob-bg w-80 h-80 bg-teal/20 top-[-10%] left-[-10%]"></div>
    <div class="blob-bg w-96 h-96 bg-purple/20 bottom-[-10%] right-[-10%]"></div>

    <div id="mainApp" class="w-full max-w-md h-screen flex flex-col relative z-10 bg-black/50 backdrop-blur-sm">
        
        <header class="px-6 pt-14 pb-2 z-20 pointer-events-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-teal to-purple p-[2px]">
                        <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Haze" class="w-full h-full rounded-full bg-black">
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 font-medium">Welcome back</p>
                        <h1 class="text-2xl font-bold text-white tracking-tight">HazeNote</h1>
                    </div>
                </div>
                <button onclick="toggleSearch()" class="w-10 h-10 rounded-full bg-dark border border-white/10 flex items-center justify-center text-gray-400 hover:text-white transition">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>

            <div id="searchContainer" class="hidden overflow-hidden">
                <div class="bg-dark border border-white/10 rounded-2xl h-full flex items-center px-4">
                    <i class="fa-solid fa-filter text-teal mr-3"></i>
                    <input id="searchInput" type="text" placeholder="Search keyword..." class="bg-transparent w-full text-white placeholder-gray-600 outline-none h-12" oninput="handleSearch(this.value)">
                    <button onclick="toggleSearch()" class="text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <div class="flex justify-between items-end mt-2">
                <h2 id="viewTitle" class="text-4xl font-bold text-white leading-none">My<br/>Notes</h2>
                <div class="flex gap-2">
                    <span id="pinCountBadge" class="text-xs bg-purple/20 text-purple px-2 py-1 rounded-lg border border-purple/20 hidden">ğŸ“Œ 0/3</span>
                    <div class="bg-dark border border-white/10 px-3 py-1 rounded-full text-xs text-gray-400 font-mono" id="noteCount">0 Notes</div>
                </div>
            </div>
        </header>

        <main id="noteList" class="flex-1 overflow-y-auto px-5 pb-32 pt-4 no-scrollbar touch-pan-y">
            </main>

        <div id="floatingContainer" style="top: 80%; left: 80%;">
            <div id="assistiveMenu" class="absolute bottom-20 right-0 bg-[#1A1A1A]/95 backdrop-blur-xl border border-white/10 rounded-2xl p-2 w-48 shadow-2xl hidden flex-col gap-1 origin-bottom-right z-50">
                <button onclick="changeView('list')" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                    <i class="fa-solid fa-list text-teal w-5"></i> <span>List View</span>
                </button>
                <button onclick="changeView('grid')" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                    <i class="fa-solid fa-border-all text-purple w-5"></i> <span>Module View</span>
                </button>
                <div class="h-px bg-white/10 my-1"></div>
                <button onclick="triggerImport()" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                    <i class="fa-solid fa-file-import text-gray-500 w-5"></i> <span>Import</span>
                </button>
                <button onclick="exportData()" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                    <i class="fa-solid fa-file-export text-gray-500 w-5"></i> <span>Export</span>
                </button>
            </div>

            <div class="relative w-16 h-16 flex items-center justify-center">
                <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" width="64" height="64" viewBox="0 0 64 64">
                    <circle id="ringCircle" class="progress-ring__circle" stroke="#85B9C9" stroke-width="4" fill="transparent" r="28" cx="32" cy="32" 
                            style="stroke-dasharray: 175.9; stroke-dashoffset: 175.9;"/>
                </svg>
                
                <div id="assistiveBtn" class="assistive-btn w-14 h-14 rounded-full bg-teal text-black text-2xl flex items-center justify-center z-10 cursor-pointer">
                    <i class="fa-solid fa-plus pointer-events-none"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col">
        <div class="px-6 pt-14 pb-4 flex justify-between items-center">
            <button onclick="closeModal()" class="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center text-white hover:bg-white/10">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <span class="text-sm font-bold text-gray-500 tracking-wider">NEW NOTE</span>
            <button onclick="saveNote()" class="w-12 h-12 rounded-full bg-teal text-black flex items-center justify-center font-bold hover:scale-105 transition">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>
        <div class="flex-1 px-8 pt-4">
            <textarea id="noteInput" class="w-full h-full bg-transparent text-white text-2xl font-medium placeholder-gray-700 resize-none leading-relaxed" placeholder="Type your thought..."></textarea>
        </div>
        <div class="px-8 pb-10 flex gap-4">
            <button onclick="setColor('dark')" class="color-btn w-8 h-8 rounded-full bg-[#111111] border border-white/20 ring-2 ring-white ring-offset-2 ring-offset-black"></button>
            <button onclick="setColor('teal')" class="color-btn w-8 h-8 rounded-full bg-teal"></button>
            <button onclick="setColor('orange')" class="color-btn w-8 h-8 rounded-full bg-orange"></button>
            <button onclick="setColor('light')" class="color-btn w-8 h-8 rounded-full bg-[#F6F6F6]"></button>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">

    <script>
        const CONFIG = { PIN_LIMIT: 3, LONG_PRESS_MS: 3000 };
        let state = {
            notes: [],
            viewMode: localStorage.getItem('haze_view_mode') || 'grid',
            searchQuery: '',
            isSearchOpen: false,
            editingColor: 'dark'
        };

        window.onload = () => {
            loadNotes();
            initDraggableButton(); // åˆå§‹åŒ–æ‹–æ‹½é€»è¾‘
        };

        function loadNotes() {
            const saved = localStorage.getItem('haze_notes_v3');
            if (saved) state.notes = JSON.parse(saved);
            renderNotes();
        }

        function saveToLocal() {
            localStorage.setItem('haze_notes_v3', JSON.stringify(state.notes));
            localStorage.setItem('haze_view_mode', state.viewMode);
            renderNotes();
        }

        // ========== æ ¸å¿ƒäº¤äº’ï¼šæ‹–æ‹½ + é•¿æŒ‰ + å•å‡» ==========
        function initDraggableButton() {
            const container = document.getElementById('floatingContainer');
            const btn = document.getElementById('assistiveBtn');
            const ring = document.getElementById('ringCircle');
            const menu = document.getElementById('assistiveMenu');
            
            // çŠ¶æ€å˜é‡
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            let longPressTimer = null;
            let isLongPressTriggered = false;

            // 1. è§¦æ‘¸å¼€å§‹
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                const touch = e.touches[0];
                
                // è®°å½•åˆå§‹ä½ç½®
                startX = touch.clientX;
                startY = touch.clientY;
                const rect = container.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                
                isDragging = false;
                isLongPressTriggered = false;
                
                // éšè—èœå•ï¼ˆå¦‚æœä¹‹å‰æ‰“å¼€äº†ï¼‰
                menu.classList.add('hidden');
                menu.classList.remove('menu-pop');

                // å¼€å§‹é•¿æŒ‰åŠ¨ç”»
                ring.classList.add('ring-filling'); 
                btn.classList.add('scale-90'); // æŒ‰ä¸‹åé¦ˆ

                // å¯åŠ¨å®šæ—¶å™¨
                longPressTimer = setTimeout(() => {
                    isLongPressTriggered = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    // æ˜¾ç¤ºèœå•
                    menu.classList.remove('hidden');
                    menu.classList.add('menu-pop');
                    // é‡ç½®åœ†ç¯
                    ring.classList.remove('ring-filling');
                }, CONFIG.LONG_PRESS_MS);
            }, {passive: false});

            // 2. è§¦æ‘¸ç§»åŠ¨ (æ‹–æ‹½é€»è¾‘)
            btn.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;

                // å¦‚æœç§»åŠ¨è¶…è¿‡ 5pxï¼Œè§†ä¸ºæ‹–æ‹½ï¼Œå–æ¶ˆé•¿æŒ‰
                if (!isDragging && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
                    isDragging = true;
                    clearTimeout(longPressTimer);
                    ring.classList.remove('ring-filling'); // ç«‹å³å–æ¶ˆåŠ¨ç”»
                    btn.classList.add('dragging'); // æ”¹å˜æ ·å¼
                    btn.classList.remove('scale-90');
                }

                if (isDragging) {
                    // æ›´æ–°ä½ç½®
                    container.style.left = `${initialLeft + deltaX}px`;
                    container.style.top = `${initialTop + deltaY}px`;
                }
            }, {passive: false});

            // 3. è§¦æ‘¸ç»“æŸ
            const endInteraction = () => {
                clearTimeout(longPressTimer);
                ring.classList.remove('ring-filling'); // é‡ç½®åŠ¨ç”»
                btn.classList.remove('scale-90');
                btn.classList.remove('dragging');

                if (isDragging) {
                    // æ‹–æ‹½ç»“æŸï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œä½ç½®ä¿ç•™
                    // å¯ä»¥åŠ å¸é™„é€»è¾‘ï¼Œä½†ç”¨æˆ·è¦æ±‚â€œè‡ªç”±æ‹–åˆ°æƒ³æ‹–çš„åœ°æ–¹â€
                } else if (!isLongPressTriggered) {
                    // ä¸æ˜¯æ‹–æ‹½ï¼Œä¹Ÿæ²¡è§¦å‘é•¿æŒ‰ -> è§†ä¸ºå•å‡»
                    openNewNoteModal();
                }
                // å¦‚æœ isLongPressTriggered ä¸º trueï¼Œèœå•å·²ç»æ‰“å¼€äº†ï¼Œä¸ç”¨å¤„ç†
            };

            btn.addEventListener('touchend', endInteraction);
            btn.addEventListener('touchcancel', endInteraction);
        }

        // ========== è§†å›¾ä¸æœç´¢ ==========
        function changeView(mode) {
            state.viewMode = mode;
            saveToLocal();
            document.getElementById('assistiveMenu').classList.add('hidden');
        }

        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            state.isSearchOpen = !state.isSearchOpen;
            if (state.isSearchOpen) {
                container.classList.remove('hidden', 'search-bar-exit');
                container.classList.add('search-bar-enter');
                document.getElementById('searchInput').focus();
            } else {
                container.classList.remove('search-bar-enter');
                container.classList.add('search-bar-exit');
                setTimeout(() => container.classList.add('hidden'), 300);
                state.searchQuery = '';
                document.getElementById('searchInput').value = '';
                renderNotes();
            }
        }

        function handleSearch(val) {
            state.searchQuery = val.toLowerCase();
            renderNotes();
        }

        // ========== æ¸²æŸ“é€»è¾‘ ==========
        function renderNotes() {
            const list = document.getElementById('noteList');
            let displayNotes = state.notes.filter(n => n.content.toLowerCase().includes(state.searchQuery));
            
            // æ’åº: ç½®é¡¶ > æ—¥æœŸ
            displayNotes.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                return new Date(b.date) - new Date(a.date);
            });

            // ç»Ÿè®¡
            document.getElementById('noteCount').innerText = `${displayNotes.length} Notes`;
            const pinnedCount = state.notes.filter(n => n.isPinned).length;
            const badge = document.getElementById('pinCountBadge');
            pinnedCount > 0 ? (badge.classList.remove('hidden'), badge.innerText = `ğŸ“Œ ${pinnedCount}/${CONFIG.PIN_LIMIT}`) : badge.classList.add('hidden');

            list.innerHTML = '';
            if (displayNotes.length === 0) {
                list.innerHTML = `<div class="text-center mt-20 text-gray-600">No notes found.</div>`;
                return;
            }

            displayNotes.forEach((note, index) => {
                let style = 'dark-simple';
                if (state.viewMode === 'list') style = 'list';
                else {
                    if (index === 0 && !state.searchQuery) style = 'large-hero';
                    else if (note.color === 'orange') style = 'orange-typo';
                    else if (note.color === 'teal') style = 'teal-block';
                    else if (note.color === 'light') style = 'light-clean';
                }
                list.innerHTML += createNoteCard(note, style);
            });

            bindSwipeEvents();
        }

        function createNoteCard(note, styleType) {
            const dateStr = new Date(note.date).toLocaleDateString('en', { month: 'short', day: 'numeric' });
            const pinnedClass = note.isPinned ? 'pinned-glow' : '';
            const pinIcon = note.isPinned ? '<i class="fa-solid fa-thumbtack text-teal absolute top-4 right-4 z-20"></i>' : '';

            let inner = '', wrapperClass = `note-card-content w-full rounded-[32px] p-6 relative z-10 overflow-hidden border border-white/5 ${pinnedClass} `;

            if (styleType === 'list') {
                wrapperClass += `bg-[#1A1A1A] min-h-[100px] flex items-center justify-between`;
                inner = `<div class="flex-1 pr-4"><p class="text-gray-200 font-medium line-clamp-1 text-lg">${note.content}</p><span class="text-xs text-gray-500 mt-1 block">${dateStr}</span></div>${note.isPinned ? '<i class="fa-solid fa-thumbtack text-teal text-sm"></i>' : ''}`;
            } else if (styleType === 'large-hero') {
                wrapperClass += `bg-[#111111] min-h-[200px] flex flex-col justify-between`;
                inner = `${pinIcon}<div class="mt-2"><span class="bg-teal text-black text-xs font-bold px-2 py-1 rounded">TODAY</span></div><p class="text-2xl font-bold text-gray-100 line-clamp-4 mt-4">${note.content}</p><div class="mt-4 text-xs text-gray-500 font-mono text-right">${dateStr}</div>`;
            } else if (styleType === 'orange-typo') {
                wrapperClass += `bg-orange text-black min-h-[160px] flex items-center justify-center text-center`;
                inner = `${note.isPinned ? '<i class="fa-solid fa-thumbtack text-black absolute top-4 right-4 z-20 opacity-50"></i>' : ''}<p class="text-4xl font-black uppercase leading-none break-all line-clamp-3">${note.content}</p><span class="absolute bottom-3 right-5 text-xs font-bold opacity-60">${dateStr}</span>`;
            } else if (styleType === 'teal-block') {
                wrapperClass += `bg-teal text-black min-h-[140px]`;
                inner = `${note.isPinned ? '<i class="fa-solid fa-thumbtack text-black absolute top-4 right-4 z-20 opacity-50"></i>' : ''}<p class="text-lg font-bold leading-tight line-clamp-4">${note.content}</p><div class="mt-4 pt-2 border-t border-black/10 text-xs font-bold opacity-60 flex justify-between"><span>Memo</span><span>${dateStr}</span></div>`;
            } else if (styleType === 'light-clean') {
                wrapperClass += `bg-[#F6F6F6] text-black min-h-[140px]`;
                inner = `${note.isPinned ? '<i class="fa-solid fa-thumbtack text-gray-400 absolute top-4 right-4 z-20"></i>' : ''}<h3 class="text-sm font-bold text-gray-400 mb-2">NOTE</h3><p class="text-gray-800 font-medium line-clamp-3">${note.content}</p>`;
            } else {
                wrapperClass += `bg-[#1A1A1A] min-h-[140px]`;
                inner = `${pinIcon}<p class="text-gray-300 font-medium line-clamp-3 mb-6">${note.content}</p><span class="absolute bottom-4 right-6 text-xs text-gray-600 font-bold tracking-widest">${dateStr}</span>`;
            }

            return `<div class="note-container" data-id="${note.id}"><div class="note-actions"><button onclick="togglePin('${note.id}')" class="w-10 h-10 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-thumbtack ${note.isPinned ? 'text-teal' : ''}"></i></button><button onclick="shareNote('${note.id}')" class="w-10 h-10 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-bolt"></i></button><button onclick="confirmDelete('${note.id}')" class="w-10 h-10 rounded-full bg-danger/20 flex items-center justify-center text-danger hover:bg-danger hover:text-white"><i class="fa-solid fa-trash"></i></button></div><div class="${wrapperClass}" id="card-${note.id}">${inner}</div></div>`;
        }

        // ========== æ‰‹åŠ¿ ==========
        function bindSwipeEvents() {
            document.querySelectorAll('.note-container').forEach(el => {
                const card = el.querySelector('.note-card-content');
                let startX, currentX;
                card.addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX;
                    // Reset others
                    document.querySelectorAll('.note-card-content').forEach(c => c !== card && (c.style.transform = `translateX(0)`));
                }, {passive: true});
                card.addEventListener('touchmove', e => {
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    if (diff < 0 && diff > -180) card.style.transform = `translateX(${diff}px)`;
                }, {passive: true});
                card.addEventListener('touchend', e => {
                    if (currentX - startX < -80) card.style.transform = `translateX(-160px)`;
                    else card.style.transform = `translateX(0)`;
                });
            });
        }

        // ========== ç¬”è®°åŠŸèƒ½ ==========
        function setColor(c) {
            state.editingColor = c;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black'));
            event.target.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black');
        }
        function openNewNoteModal() {
            document.getElementById('noteInput').value = '';
            setColor('dark');
            document.getElementById('noteModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('noteInput').focus(), 100);
        }
        function closeModal() { document.getElementById('noteModal').classList.add('hidden'); }
        function saveNote() {
            const content = document.getElementById('noteInput').value.trim();
            if (!content) return closeModal();
            state.notes.unshift({ id: Date.now().toString(), content, date: new Date().toISOString(), color: state.editingColor, isPinned: false });
            saveToLocal(); closeModal();
        }
        function togglePin(id) {
            const note = state.notes.find(n => n.id === id);
            if (!note) return;
            if (!note.isPinned && state.notes.filter(n => n.isPinned).length >= CONFIG.PIN_LIMIT) return alert(`Max ${CONFIG.PIN_LIMIT} pins.`);
            note.isPinned = !note.isPinned; saveToLocal();
        }
        function confirmDelete(id) { if(confirm("Delete note?")) { state.notes = state.notes.filter(n => n.id !== id); saveToLocal(); } }
        function shareNote(id) {
            const n = state.notes.find(x => x.id === id);
            navigator.share ? navigator.share({title:'HazeNote',text:n.content}) : (navigator.clipboard.writeText(n.content), alert('Copied'));
        }

        // ========== I/O ==========
        function exportData() {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.notes));
            a.download = `HazeNote_${Date.now()}.json`; a.click();
        }
        function triggerImport() { document.getElementById('fileInput').click(); }
        function importData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(Array.isArray(d)) { state.notes = [...d.filter(n => !state.notes.some(x=>x.id===n.id)), ...state.notes]; saveToLocal(); alert('Imported.'); }
                } catch(err) { alert('Invalid file'); }
            }; r.readAsText(f);
        }
    </script>
</body>
</html>
