<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazeNote V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a0a', // 截图中的深邃黑背景
                        card: '#1a1a1a',
                        purple: '#7B61FF', // 截图中的电光紫
                        orange: '#FF6B4A', // 截图中的珊瑚橙
                        yellow: '#D4A853', // 截图中的金色
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'sans-serif'],
                        serif: ['"Noto Serif SC"', 'Georgia', 'serif'], // 用于大标题
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { 
            background-color: #0a0a0a; 
            color: white; 
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; 
        }
        
        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* === 核心视觉元素：有机流体形状 (Blobs) === */
        /* 通过 border-radius 模拟截图中的不规则色块 */
        .blob-purple {
            background: linear-gradient(135deg, #8B71FF 0%, #7B61FF 50%, #6B51EF 100%);
            border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
            filter: blur(40px); /* 背景模糊 */
            opacity: 0.6;
        }
        .blob-shape-card {
            border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
        }
        
        /* 浮动动画 */
        .float { animation: float 10s ease-in-out infinite; }
        @keyframes float { 
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); } 
            50% { transform: translateY(-20px) rotate(5deg) scale(1.05); }
        }

        /* === 卡片风格 === */
        .note-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .note-card:active { transform: scale(0.98); }

        /* 风格1：深色带流体 (类似截图 Task today) */
        .card-style-dark {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid rgba(255,255,255,0.05);
        }
        /* 风格2：亮色排版 (类似截图 UI Trend) */
        .card-style-light {
            background-color: #f5f5f5;
            color: #0a0a0a;
        }
        /* 风格3：橙色大字 (类似截图 Year End Party) */
        .card-style-orange {
            background: linear-gradient(135deg, #FF8B6A 0%, #FF6B4A 100%);
            color: #0a0a0a;
        }

        /* 装饰用的流体 */
        .card-blob {
            position: absolute;
            top: -20px; right: -20px;
            width: 100px; height: 100px;
            background: #7B61FF;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            z-index: 0;
        }

        /* 底部导航栏玻璃态 */
        .glass-nav {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        /* 按钮光晕 */
        .glow-shadow {
            box-shadow: 0 0 20px rgba(123, 97, 255, 0.3);
        }

        /* 字体类 */
        .font-display { font-family: 'Noto Serif SC', serif; }
        
        /* 输入框聚焦 */
        textarea:focus { outline: none; }
    </style>
</head>
<body class="flex justify-center min-h-screen overflow-hidden bg-dark">

    <div class="fixed top-[-10%] right-[-20%] w-[300px] h-[300px] blob-purple float pointer-events-none z-0"></div>
    <div class="fixed bottom-[10%] left-[-10%] w-[250px] h-[250px] blob-purple float pointer-events-none z-0" style="background: #FF6B4A; animation-delay: -5s;"></div>

    <div id="loginScreen" class="w-full max-w-md h-full flex flex-col items-center justify-center px-8 relative z-50 bg-dark/95 backdrop-blur-xl">
        <h1 class="text-6xl font-display font-bold text-white mb-2 tracking-tight">Haze<br/><span class="text-purple">Note.</span></h1>
        <p class="text-gray-400 text-sm mb-12 tracking-wide font-serif italic">Capture your thoughts in style.</p>
        
        <button id="passkeyBtn" onclick="handlePasskey()" class="w-full py-4 rounded-full bg-white text-dark font-bold text-lg shadow-[0_0_30px_rgba(255,255,255,0.2)] hover:scale-105 transition-transform flex items-center justify-center gap-2">
            <i class="fa-solid fa-fingerprint text-xl"></i>
            <span id="passkeyBtnText">Unlock with FaceID</span>
        </button>
        <div id="loginError" class="mt-4 text-orange text-sm hidden"></div>
    </div>

    <div id="mainApp" class="w-full max-w-md h-screen flex flex-col hidden relative z-10">
        
        <header class="px-6 pt-14 pb-4 flex justify-between items-end z-20">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Brian" class="w-6 h-6 rounded-full bg-gray-800" alt="Avatar">
                    <span class="text-xs text-gray-400">Hi, Traveler</span>
                </div>
                <h1 class="text-5xl font-display font-light text-white leading-none">My<br/><span class="font-bold">Notes</span></h1>
            </div>
            
            <div class="bg-[#1a1a1a] border border-white/10 rounded-full p-1 pl-4 flex items-center gap-3 h-12">
                <i class="fa-solid fa-magnifying-glass text-gray-400 text-sm"></i>
                <div class="bg-white text-dark font-bold rounded-full w-9 h-9 flex items-center justify-center text-sm" id="noteCountBadge">0</div>
            </div>
        </header>

        <main id="noteList" class="flex-1 overflow-y-auto px-5 pb-32 space-y-4 no-scrollbar pt-2">
            </main>

        <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50 pointer-events-none">
            <div class="pointer-events-auto bg-[#0a0a0a] border border-white/10 shadow-2xl rounded-[30px] px-2 py-2 flex items-center gap-2">
                <button onclick="exportData()" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition">
                    <i class="fa-solid fa-file-export"></i>
                </button>
                
                <button onclick="triggerImport()" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition">
                    <i class="fa-solid fa-file-import"></i>
                </button>

                <button onclick="lockApp()" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition">
                    <i class="fa-solid fa-lock"></i>
                </button>

                <button onclick="openNewNoteModal()" class="w-16 h-12 rounded-[24px] bg-white text-black flex items-center justify-center ml-2 hover:scale-105 transition shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                    <i class="fa-solid fa-plus text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-dark z-[60] hidden flex flex-col">
        <div class="px-6 pt-14 pb-4 flex justify-between items-center">
            <button onclick="closeModal()" class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center text-white">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div class="flex gap-2">
                <div class="text-xs text-gray-400 border border-white/10 px-3 py-1 rounded-full flex items-center gap-2">
                    <span id="modalDate">Today</span>
                </div>
            </div>
            <button onclick="saveNote()" class="w-10 h-10 rounded-full bg-purple text-white flex items-center justify-center glow-shadow">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>

        <div class="flex-1 px-6 pt-4">
            <textarea id="noteInput" class="w-full h-full bg-transparent text-white text-xl leading-relaxed font-serif placeholder-gray-600 resize-none" placeholder="Start typing your thoughts..."></textarea>
        </div>

        <div class="px-6 pb-10 pt-4">
            <div class="flex justify-between items-center bg-[#1a1a1a] p-2 rounded-2xl border border-white/5">
                <div class="flex gap-2" id="colorPickerContainer">
                    <button onclick="selectColor('dark')" class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-white/20 ring-2 ring-white ring-offset-2 ring-offset-[#1a1a1a] color-btn"></button>
                    <button onclick="selectColor('light')" class="w-8 h-8 rounded-full bg-[#f5f5f5] color-btn"></button>
                    <button onclick="selectColor('orange')" class="w-8 h-8 rounded-full bg-[#FF6B4A] color-btn"></button>
                    <button onclick="selectColor('purple')" class="w-8 h-8 rounded-full bg-[#7B61FF] color-btn"></button>
                </div>
                <span class="text-xs text-gray-500 font-mono" id="charCount">0/1000</span>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">

    <script>
    /* 保留 V2 的核心逻辑 (Passkey, 加密, 存储)
       重写 UI 渲染逻辑 (renderNotes) 以适配新设计
    */

    // ========== Passkey & Crypto Modules (保持不变) ==========
    const PasskeyModule = {
        CREDENTIAL_KEY: 'hazenote_passkey_credential',
        ENCRYPTION_KEY_STORAGE: 'hazenote_passkey_encryption_key',
        isSupported() { return window.PublicKeyCredential !== undefined; },
        hasCredential() { return localStorage.getItem(this.CREDENTIAL_KEY) !== null; },
        bufferToBase64URL(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = ''; for (const byte of bytes) str += String.fromCharCode(byte);
            return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        },
        base64URLToBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padded = base64 + '='.repeat((4 - base64.length % 4) % 4);
            const binary = atob(padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        },
        async register() {
            const userId = crypto.getRandomValues(new Uint8Array(16));
            const challenge = crypto.getRandomValues(new Uint8Array(32));
            const encryptionKey = this.bufferToBase64URL(crypto.getRandomValues(new Uint8Array(32)));
            const options = {
                challenge, rp: { name: 'HazeNote', id: location.hostname || 'localhost' },
                user: { id: userId, name: 'HazeNote User', displayName: 'HazeNote User' },
                pubKeyCredParams: [{ alg: -7, type: 'public-key' }, { alg: -257, type: 'public-key' }],
                authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'required', residentKey: 'preferred' },
                timeout: 60000, attestation: 'none'
            };
            const credential = await navigator.credentials.create({ publicKey: options });
            localStorage.setItem(this.CREDENTIAL_KEY, JSON.stringify({ id: credential.id, rawId: this.bufferToBase64URL(credential.rawId) }));
            localStorage.setItem(this.ENCRYPTION_KEY_STORAGE, encryptionKey);
            return encryptionKey;
        },
        async authenticate() {
            const stored = JSON.parse(localStorage.getItem(this.CREDENTIAL_KEY));
            if (!stored) throw new Error('NO_CREDENTIAL');
            const options = {
                challenge: crypto.getRandomValues(new Uint8Array(32)),
                rpId: location.hostname || 'localhost',
                allowCredentials: [{ id: this.base64URLToBuffer(stored.rawId), type: 'public-key', transports: ['internal'] }],
                userVerification: 'required', timeout: 60000
            };
            await navigator.credentials.get({ publicKey: options });
            return localStorage.getItem(this.ENCRYPTION_KEY_STORAGE);
        }
    };

    const CryptoModule = {
        async importKey(keyString) {
            const keyData = new TextEncoder().encode(keyString.padEnd(32, '0').substring(0, 32));
            return crypto.subtle.importKey('raw', keyData, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        },
        async encrypt(data, keyString) {
            const key = await this.importKey(keyString);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(JSON.stringify(data)));
            const result = new Uint8Array(iv.length + encrypted.byteLength);
            result.set(iv, 0); result.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...result));
        },
        async decrypt(encryptedBase64, keyString) {
            try {
                const key = await this.importKey(keyString);
                const data = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: data.slice(0, 12) }, key, data.slice(12));
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch { return null; }
        }
    };

    const DataModule = {
        NOTES_KEY: 'hazenote_encrypted_data',
        async save(notes, key) { localStorage.setItem(this.NOTES_KEY, await CryptoModule.encrypt(notes, key)); },
        async load(key) { const d = localStorage.getItem(this.NOTES_KEY); return d ? await CryptoModule.decrypt(d, key) || [] : []; }
    };

    const Session = {
        KEY: 'hazenote_session',
        get() { const s = sessionStorage.getItem(this.KEY); return s ? JSON.parse(s) : null; },
        set(key) { sessionStorage.setItem(this.KEY, JSON.stringify({ encryptionKey: key })); },
        clear() { sessionStorage.removeItem(this.KEY); }
    };

    // ========== App Logic ==========
    let notes = [];
    let selectedColor = 'dark'; // dark, light, orange, purple

    // 初始化
    window.onload = async () => {
        if (!PasskeyModule.isSupported()) { 
            alert('Your browser does not support Passkey.'); 
            document.getElementById('passkeyBtn').style.display = 'none';
        }
        updateLoginBtn();
        const s = Session.get(); 
        if (s) await initApp(s.encryptionKey);
        
        // 字数统计监听
        document.getElementById('noteInput').addEventListener('input', e => {
            document.getElementById('charCount').textContent = e.target.value.length + '/1000';
        });
    };

    function updateLoginBtn() {
        const has = PasskeyModule.hasCredential();
        document.getElementById('passkeyBtnText').textContent = has ? 'Unlock with FaceID' : 'Create Secure Passkey';
    }

    async function handlePasskey() {
        try {
            const key = PasskeyModule.hasCredential() ? await PasskeyModule.authenticate() : await PasskeyModule.register();
            Session.set(key); await initApp(key);
        } catch (e) {
            if (e.message === 'NO_CREDENTIAL') { 
                alert('Passkey invalid. Please re-create.'); 
                localStorage.removeItem(PasskeyModule.CREDENTIAL_KEY);
                updateLoginBtn();
            } else {
                alert('Authentication failed.');
            }
        }
    }

    async function initApp(key) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        notes = await DataModule.load(key);
        renderNotes();
    }

    function lockApp() {
        Session.clear();
        notes = [];
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
    }

    // ========== 渲染逻辑 (UI的核心部分) ==========
    function renderNotes() {
        const list = document.getElementById('noteList');
        list.innerHTML = '';
        document.getElementById('noteCountBadge').textContent = notes.length;

        if (notes.length === 0) {
            list.innerHTML = `
                <div class="mt-20 flex flex-col items-center opacity-30">
                    <div class="w-24 h-24 blob-purple mb-4 rounded-full"></div>
                    <p class="font-serif italic text-lg">No notes yet.</p>
                </div>
            `;
            return;
        }

        // 排序：最新的在最前
        notes.sort((a, b) => new Date(b.date) - new Date(a.date));

        notes.forEach(note => {
            const el = document.createElement('div');
            
            // 根据颜色选择样式类
            let styleClass = 'card-style-dark';
            let blobEl = ''; // 只有 dark 模式加装饰斑点
            let textColor = 'text-white';
            let metaColor = 'text-gray-400';
            let deleteBtnColor = 'text-gray-500 hover:text-white';
            
            if (note.color === 'light') {
                styleClass = 'card-style-light';
                textColor = 'text-black';
                metaColor = 'text-gray-500';
                deleteBtnColor = 'text-gray-400 hover:text-red-500';
            } else if (note.color === 'orange') {
                styleClass = 'card-style-orange';
                textColor = 'text-black';
                metaColor = 'text-gray-800';
                deleteBtnColor = 'text-black/50 hover:text-black';
            } else if (note.color === 'purple') {
                styleClass = 'bg-[#7B61FF] text-white'; // Purple solid
                textColor = 'text-white';
                metaColor = 'text-white/70';
                deleteBtnColor = 'text-white/60 hover:text-white';
            } else {
                // Dark (Default) - add blob decoration
                blobEl = `<div class="card-blob opacity-20"></div>`;
                // Random organic shape for dark cards to match screenshot variety
                const shapes = ['rounded-[30px]', 'rounded-[30px_30px_30px_0]', 'rounded-[30px_30px_0_30px]'];
                // el.className += ' ' + shapes[Math.floor(Math.random()*shapes.length)]; 
            }

            el.className = `note-card w-full p-6 rounded-[32px] mb-4 flex flex-col justify-between min-h-[160px] cursor-pointer group ${styleClass}`;
            
            // Format Date
            const d = new Date(note.date);
            const dateStr = `${d.getDate()}th ${d.toLocaleString('default', { month: 'short' })} ${d.getFullYear()}`;

            // 根据截图：如果是 Orange，用大字体展示；如果是 Light/Dark，用标准排版
            let contentHtml = '';
            if (note.color === 'orange') {
                contentHtml = `<p class="text-4xl font-display font-bold leading-tight line-clamp-3 mb-4">${note.content}</p>`;
            } else {
                contentHtml = `
                    <h3 class="font-display text-2xl font-bold mb-2">Note</h3>
                    <p class="text-base leading-relaxed opacity-90 line-clamp-3 font-sans">${note.content}</p>
                `;
            }

            el.innerHTML = `
                ${blobEl}
                <div class="relative z-10 flex-1">
                    ${contentHtml}
                </div>
                <div class="relative z-10 flex justify-between items-end mt-4">
                    <span class="text-xs font-bold uppercase tracking-wider ${metaColor}">${dateStr}</span>
                    <button onclick="event.stopPropagation(); deleteNote('${note.id}')" class="${deleteBtnColor} transition p-2 -mr-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `;
            
            // 点击查看/复制逻辑 (简化为复制)
            el.onclick = () => {
                navigator.clipboard.writeText(note.content).then(() => alert('Copied to clipboard!'));
            };

            list.appendChild(el);
        });
    }

    // ========== 操作逻辑 ==========
    function selectColor(color) {
        selectedColor = color;
        // Update UI ring
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.className = btn.className.replace('ring-2 ring-white ring-offset-2 ring-offset-[#1a1a1a]', '');
        });
        event.target.className += ' ring-2 ring-white ring-offset-2 ring-offset-[#1a1a1a]';
    }

    function openNewNoteModal() {
        document.getElementById('noteInput').value = '';
        document.getElementById('charCount').textContent = '0/1000';
        // Reset color to dark
        selectColor('dark');
        document.getElementById('noteModal').classList.remove('hidden');
        document.getElementById('noteInput').focus();
        
        // Date in modal
        const d = new Date();
        document.getElementById('modalDate').textContent = `${d.toLocaleString('default', { weekday: 'short' })}, ${d.getDate()} ${d.toLocaleString('default', { month: 'short' })}`;
    }

    function closeModal() {
        document.getElementById('noteModal').classList.add('hidden');
    }

    async function saveNote() {
        const content = document.getElementById('noteInput').value.trim();
        if (!content) return closeModal();

        const newNote = {
            id: Date.now().toString(),
            content: content,
            date: new Date().toISOString(),
            color: selectedColor
        };

        notes.unshift(newNote);
        await DataModule.save(notes, Session.get().encryptionKey);
        renderNotes();
        closeModal();
    }

    async function deleteNote(id) {
        if(confirm('Delete this note?')) {
            notes = notes.filter(n => n.id !== id);
            await DataModule.save(notes, Session.get().encryptionKey);
            renderNotes();
        }
    }

    // Import / Export
    async function exportData() {
        const d = { app: 'HazeNote', version: '3.0', notes };
        const a = document.createElement('a');
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(d, null, 2));
        a.download = `HazeNote_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function triggerImport() { document.getElementById('fileInput').click(); }
    
    async function importData(input) {
        const f = input.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = async e => {
            try {
                const d = JSON.parse(e.target.result);
                if (d.app === 'HazeNote') {
                    // Merge and dedup
                    const currentIds = new Set(notes.map(n => n.id));
                    const newNotes = d.notes.filter(n => !currentIds.has(n.id));
                    notes = [...newNotes, ...notes];
                    await DataModule.save(notes, Session.get().encryptionKey);
                    renderNotes();
                    alert(`Imported ${newNotes.length} notes.`);
                }
            } catch { alert('Invalid backup file.'); }
        };
        r.readAsText(f);
    }
    </script>
</body>
</html>
