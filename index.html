<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazeNote V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a0a',
                        card: '#1a1a1a',
                        purple: '#7B61FF',
                        orange: '#FF6B4A',
                        yellow: '#D4A853',
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { 
            background-color: #0a0a0a; 
            color: white; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            overscroll-behavior: none; 
        }
        .font-serif { font-family: 'Noto Serif SC', 'Georgia', 'Songti SC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æœ‰æœºå½¢çŠ¶ - Appleé£æ ¼çš„æŸ”å’Œå½¢æ€ */
        .blob-purple {
            background: linear-gradient(135deg, #8B71FF 0%, #7B61FF 50%, #6B51EF 100%);
            border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
            filter: blur(0.5px);
        }
        .blob-orange {
            background: linear-gradient(135deg, #FF8B6A 0%, #FF6B4A 50%, #F55A3A 100%);
            border-radius: 37% 63% 46% 54% / 48% 55% 45% 52%;
            filter: blur(0.5px);
        }
        .blob-yellow {
            background: linear-gradient(135deg, #E4B863 0%, #D4A853 50%, #C49843 100%);
            border-radius: 54% 46% 63% 37% / 52% 45% 55% 48%;
            filter: blur(0.5px);
        }
        
        /* å››è§’æ˜Ÿ */
        .star-4 {
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        
        /* ä¾¿ç­¾å¡ç‰‡ - ç²¾è‡´é˜´å½± */
        .note-card {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .note-card:active { transform: scale(0.98); }
        
        /* é¢œè‰²æ ‡è®° - æ›´æŸ”å’Œçš„æ¸å˜ */
        .tagged-purple { 
            background: linear-gradient(145deg, #8B71FF 0%, #7B61FF 40%, #6B51EF 100%);
            box-shadow: 0 4px 20px rgba(123, 97, 255, 0.25);
        }
        .tagged-orange { 
            background: linear-gradient(145deg, #FF8B6A 0%, #FF6B4A 40%, #F55A3A 100%);
            box-shadow: 0 4px 20px rgba(255, 107, 74, 0.25);
        }
        .tagged-yellow { 
            background: linear-gradient(145deg, #E4B863 0%, #D4A853 40%, #C49843 100%);
            box-shadow: 0 4px 20px rgba(212, 168, 83, 0.25);
        }
        .tagged-none { 
            background: linear-gradient(145deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid rgba(255,255,255,0.06);
        }
        
        /* æ»‘åŠ¨åŠ¨ä½œ */
        .swipe-actions {
            position: absolute; top: 0; right: 0; bottom: 0; width: 140px;
            display: flex; align-items: center; justify-content: flex-end; gap: 8px; padding-right: 12px;
            background: linear-gradient(90deg, transparent 0%, #0a0a0a 30%);
        }
        .card-inner {
            position: relative; z-index: 2;
            transform: translateX(0); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            will-change: transform;
        }
        .note-card.swiped .card-inner { transform: translateX(-140px); }
        
        /* Passkey æŒ‰é’® - Robinhoodé£æ ¼æ¸å˜ */
        .passkey-btn {
            background: linear-gradient(135deg, #8B71FF 0%, #9B71FF 25%, #C07BFF 50%, #FF8B7A 75%, #FF7B6A 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(123, 97, 255, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .passkey-btn:hover { 
            transform: translateY(-2px) scale(1.01); 
            box-shadow: 
                0 8px 25px rgba(123, 97, 255, 0.4),
                0 2px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        .passkey-btn:active { 
            transform: translateY(0) scale(0.99);
            box-shadow: 
                0 2px 10px rgba(123, 97, 255, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* æ˜Ÿæ˜Ÿé—ªçƒ - æ›´è‡ªç„¶çš„åŠ¨ç”» */
        .sparkle { 
            animation: sparkle 4s ease-in-out infinite;
            filter: drop-shadow(0 0 2px currentColor);
        }
        @keyframes sparkle { 
            0%, 100% { opacity: 0.2; transform: scale(0.8) rotate(0deg); } 
            50% { opacity: 0.9; transform: scale(1.1) rotate(20deg); } 
        }
        
        /* æµ®åŠ¨åŠ¨ç”» - Appleé£æ ¼æµç•… */
        .float { animation: float 10s ease-in-out infinite; }
        @keyframes float { 
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); } 
            33% { transform: translateY(-12px) rotate(2deg) scale(1.02); }
            66% { transform: translateY(-6px) rotate(-1deg) scale(0.99); }
        }
        
        /* åŠ å·æŒ‰é’® */
        .add-btn {
            background: linear-gradient(135deg, #7B61FF 0%, #9B61FF 50%, #FF6B4A 100%);
            box-shadow: 
                0 4px 15px rgba(123, 97, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .add-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(123, 97, 255, 0.5);
        }
        .add-btn:active {
            transform: scale(0.95);
        }
        
        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* è¾“å…¥æ¡†èšç„¦æ•ˆæœ */
        textarea:focus {
            box-shadow: 
                0 0 0 2px rgba(123, 97, 255, 0.2),
                0 4px 20px rgba(123, 97, 255, 0.1);
        }
        
        /* å›¾æ ‡å®¹å™¨æ‚¬æµ®æ•ˆæœ */
        .icon-box {
            transition: all 0.2s ease;
        }
        .icon-box:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="flex justify-center min-h-screen overflow-hidden">
    <!-- ========== ç™»å½•ç•Œé¢ ========== -->
    <div id="loginScreen" class="w-full max-w-md min-h-screen flex flex-col items-center justify-center bg-dark px-8 relative overflow-hidden">
        <!-- è£…é¥°å›¾å½¢ - å³ä¸Šè§’å¤§å—ï¼ˆå±‚å æ•ˆæœï¼‰ -->
        <div class="absolute -top-16 -right-16 w-72 h-72 blob-purple float" style="z-index: 1;"></div>
        <div class="absolute top-12 right-0 w-36 h-36 blob-orange float" style="animation-delay: -2s; z-index: 2;"></div>
        
        <!-- å·¦ä¸‹è§’è£…é¥° -->
        <div class="absolute -bottom-16 -left-16 w-48 h-48 blob-yellow opacity-95 float" style="animation-delay: -4s;"></div>
        
        <!-- å››è§’æ˜Ÿè£…é¥° - ç²¾è‡´åˆ†å¸ƒ -->
        <div class="absolute top-52 left-10 w-5 h-5 bg-yellow star-4 sparkle"></div>
        <div class="absolute bottom-36 right-24 w-4 h-4 bg-purple star-4 sparkle" style="animation-delay: -2s;"></div>
        <div class="absolute top-24 left-24 w-3 h-3 bg-purple/40 star-4 sparkle" style="animation-delay: -3s;"></div>
        <div class="absolute bottom-48 right-8 w-3 h-3 bg-orange/50 star-4 sparkle" style="animation-delay: -1s;"></div>
        
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-12 z-10">
            <h1 class="text-[52px] font-bold text-white mb-5 tracking-tight leading-[1.1]" style="font-family: 'Inter', -apple-system, sans-serif; letter-spacing: -0.02em;">
                Haze<br/>Note
            </h1>
            <p class="text-gray-500 text-[15px] tracking-wide" style="letter-spacing: 0.05em;">å®‰å…¨åŠ å¯† Â· æœ¬åœ°å­˜å‚¨</p>
        </div>
        
        <!-- Passkey æŒ‰é’® -->
        <div class="w-full z-10">
            <button id="passkeyBtn" onclick="handlePasskey()" class="passkey-btn w-full py-5 rounded-2xl text-white font-semibold text-base flex items-center justify-center gap-3">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4"/>
                    <path d="M5 19.5C5.5 18 6 15 6 12c0-.7.12-1.37.34-2"/>
                    <path d="M17.29 21.02c.12-.6.43-2.3.5-3.02"/>
                    <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"/>
                    <path d="M8.65 22c.21-.66.45-1.32.57-2"/>
                    <path d="M14 13.12c0 2.38 0 6.38-1 8.88"/>
                    <path d="M2 16h.01"/>
                    <path d="M21.8 16c.2-2 .131-5.354 0-6"/>
                    <path d="M9 6.8a6 6 0 0 1 9 5.2c0 .47 0 1.17-.02 2"/>
                </svg>
                <span id="passkeyBtnText">åˆ›å»º Passkey</span>
            </button>
        </div>
        
        <!-- åº•éƒ¨è¯´æ˜ - ç²¾è‡´å›¾æ ‡ç›’å­ -->
        <div class="mt-12 z-10 flex items-center justify-center gap-10">
            <div class="flex items-center gap-3">
                <div class="icon-box w-9 h-9 rounded-xl bg-gradient-to-br from-purple/20 to-purple/10 flex items-center justify-center border border-purple/20 shadow-lg shadow-purple/10">
                    <svg class="w-[18px] h-[18px] text-purple" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                </div>
                <span class="text-gray-400 text-[13px] font-medium">ç«¯åˆ°ç«¯åŠ å¯†</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="icon-box w-9 h-9 rounded-xl bg-gradient-to-br from-orange/20 to-orange/10 flex items-center justify-center border border-orange/20 shadow-lg shadow-orange/10">
                    <svg class="w-[18px] h-[18px] text-orange" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    </svg>
                </div>
                <span class="text-gray-400 text-[13px] font-medium">ç”Ÿç‰©è¯†åˆ«</span>
            </div>
        </div>
        
        <div id="loginError" class="hidden mt-4 text-red-400 text-sm text-center z-10"></div>
    </div>

    <!-- ========== ä¸»åº”ç”¨ç•Œé¢ ========== -->
    <div id="mainApp" class="w-full max-w-md min-h-screen flex flex-col bg-dark hidden relative">
        <!-- é¡¶éƒ¨è£…é¥° -->
        <div class="absolute -top-8 -right-8 w-36 h-36 blob-purple opacity-50 float"></div>
        <div class="absolute top-10 right-2 w-16 h-16 blob-orange opacity-60 float" style="animation-delay: -2s;"></div>
        
        <!-- Header -->
        <header class="relative z-20 px-6 pt-14 pb-4">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm mb-1" id="headerDate">Hi âœ¦</p>
                    <h1 class="text-4xl font-bold text-white tracking-tight leading-tight">My<br/>Notes</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="lockApp()" class="w-11 h-11 rounded-full bg-card flex items-center justify-center border border-white/10 hover:bg-white/5 transition">
                        <i class="fa-solid fa-lock text-white/70 text-sm"></i>
                    </button>
                    <div class="bg-card rounded-full pl-3 pr-4 py-2.5 flex items-center gap-2 border border-white/10">
                        <i class="fa-solid fa-search text-gray-600 text-xs"></i>
                        <span id="statCount" class="text-white font-bold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="flex gap-3 mt-6">
                <div class="flex-1 bg-purple/10 rounded-2xl p-4 border border-purple/20">
                    <p class="text-purple text-xl font-bold" id="statChars">0</p>
                    <p class="text-gray-500 text-xs mt-1">æ€»å­—æ•°</p>
                </div>
                <div class="flex-1 bg-orange/10 rounded-2xl p-4 border border-orange/20">
                    <p class="text-orange text-xl font-bold" id="statDays">0</p>
                    <p class="text-gray-500 text-xs mt-1">å¤©æ•°</p>
                </div>
                <div class="flex-1 bg-yellow/10 rounded-2xl p-4 border border-yellow/20">
                    <p class="text-yellow text-xl font-bold" id="statWeather">--</p>
                    <p class="text-gray-500 text-xs mt-1">å¤©æ°”</p>
                </div>
            </div>
        </header>

        <!-- ä¾¿ç­¾åˆ—è¡¨ -->
        <main id="noteList" class="flex-1 overflow-y-auto px-6 pb-32 no-scrollbar relative z-10"></main>

        <!-- åº•éƒ¨å·¥å…·æ  -->
        <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-gradient-to-t from-dark via-dark to-transparent pt-10 pb-8 px-6 z-30">
            <div class="bg-card/80 backdrop-blur-xl rounded-2xl p-1.5 flex justify-between items-center border border-white/10">
                <button onclick="triggerImport()" class="flex-1 py-3.5 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 transition flex items-center justify-center">
                    <i class="fa-solid fa-file-import text-sm"></i>
                </button>
                <button onclick="exportData()" class="flex-1 py-3.5 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 transition flex items-center justify-center">
                    <i class="fa-solid fa-file-export text-sm"></i>
                </button>
                <button onclick="openNewNoteModal()" class="w-14 h-14 rounded-xl add-btn text-white flex items-center justify-center -my-1">
                    <i class="fa-solid fa-plus text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ========== æ–°å»ºä¾¿ç­¾å¼¹çª— ========== -->
    <div id="noteModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-end justify-center">
        <div class="bg-card w-full max-w-md rounded-t-[28px] p-6 pb-10 relative overflow-hidden">
            <!-- è£…é¥° -->
            <div class="absolute -top-16 right-6 w-20 h-20 blob-purple opacity-30"></div>
            <div class="absolute -top-8 right-20 w-12 h-12 blob-orange opacity-40"></div>
            
            <div class="flex justify-between items-center mb-5 relative z-10">
                <button onclick="closeModal()" class="text-gray-500 hover:text-white transition">å–æ¶ˆ</button>
                <div class="w-10 h-1 bg-gray-700 rounded-full"></div>
                <button onclick="saveNote()" class="text-purple font-semibold">ä¿å­˜</button>
            </div>
            
            <div class="relative z-10">
                <textarea id="noteInput" 
                    class="w-full h-44 bg-dark/50 rounded-2xl p-4 text-white text-base resize-none focus:outline-none focus:ring-2 focus:ring-purple/30 placeholder-gray-600 font-serif leading-relaxed" 
                    placeholder="å†™ç‚¹ä»€ä¹ˆ..."
                    maxlength="1000"></textarea>
                <div class="flex justify-between items-center mt-3 px-1">
                    <span class="text-gray-600 text-xs" id="modalWeather"></span>
                    <span class="text-gray-600 text-xs" id="charCount">0/1000</span>
                </div>
            </div>
            
            <!-- é¢œè‰²é€‰æ‹© -->
            <div class="flex gap-2 mt-5 relative z-10">
                <button onclick="selectColor('none')" class="color-btn flex-1 py-2.5 rounded-xl bg-dark border border-white/10 text-gray-500 text-xs">æ— </button>
                <button onclick="selectColor('purple')" class="color-btn flex-1 py-2.5 rounded-xl bg-purple text-white text-xs">ğŸ’œ ç´«</button>
                <button onclick="selectColor('orange')" class="color-btn flex-1 py-2.5 rounded-xl bg-orange text-white text-xs">ğŸ§¡ æ©™</button>
                <button onclick="selectColor('yellow')" class="color-btn flex-1 py-2.5 rounded-xl bg-yellow text-dark text-xs font-medium">ğŸ’› é»„</button>
            </div>
        </div>
    </div>

    <!-- ========== åˆ†äº«é¢„è§ˆ ========== -->
    <div id="sharePreviewOverlay" class="fixed inset-0 bg-black/95 z-[60] hidden flex flex-col items-center justify-center p-4">
        <canvas id="shareCanvas" width="1600" height="838" style="width: 90%; max-width: 400px; border-radius: 20px;"></canvas>
        <div id="shareData" style="display:none;"><span id="shareText"></span><span id="shareFooterInfo"></span><span id="shareWeatherSmall"></span><span id="shareAccentColor">#7B61FF</span></div>
        <div class="flex gap-3 mt-8">
            <button onclick="closeShare()" class="px-5 py-3 rounded-xl bg-card text-white text-sm border border-white/10">å…³é—­</button>
            <button onclick="downloadImage()" class="px-5 py-3 rounded-xl bg-white/5 text-white text-sm border border-white/10"><i class="fa-solid fa-download mr-2"></i>ä¿å­˜</button>
            <button onclick="shareNative()" class="px-5 py-3 rounded-xl add-btn text-white text-sm font-medium"><i class="fa-solid fa-share mr-2"></i>åˆ†äº«</button>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">

    <script>
    // ========== Passkey æ¨¡å— ==========
    const PasskeyModule = {
        CREDENTIAL_KEY: 'hazenote_passkey_credential',
        ENCRYPTION_KEY_STORAGE: 'hazenote_passkey_encryption_key',
        isSupported() { return window.PublicKeyCredential !== undefined; },
        hasCredential() { return localStorage.getItem(this.CREDENTIAL_KEY) !== null; },
        bufferToBase64URL(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = ''; for (const byte of bytes) str += String.fromCharCode(byte);
            return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        },
        base64URLToBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padded = base64 + '='.repeat((4 - base64.length % 4) % 4);
            const binary = atob(padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        },
        async register() {
            const userId = crypto.getRandomValues(new Uint8Array(16));
            const challenge = crypto.getRandomValues(new Uint8Array(32));
            const encryptionKey = this.bufferToBase64URL(crypto.getRandomValues(new Uint8Array(32)));
            const options = {
                challenge, rp: { name: 'HazeNote', id: location.hostname || 'localhost' },
                user: { id: userId, name: 'HazeNote User', displayName: 'HazeNote ç”¨æˆ·' },
                pubKeyCredParams: [{ alg: -7, type: 'public-key' }, { alg: -257, type: 'public-key' }],
                authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'required', residentKey: 'preferred' },
                timeout: 60000, attestation: 'none'
            };
            const credential = await navigator.credentials.create({ publicKey: options });
            localStorage.setItem(this.CREDENTIAL_KEY, JSON.stringify({ id: credential.id, rawId: this.bufferToBase64URL(credential.rawId) }));
            localStorage.setItem(this.ENCRYPTION_KEY_STORAGE, encryptionKey);
            return encryptionKey;
        },
        async authenticate() {
            const stored = JSON.parse(localStorage.getItem(this.CREDENTIAL_KEY));
            if (!stored) throw new Error('NO_CREDENTIAL');
            const options = {
                challenge: crypto.getRandomValues(new Uint8Array(32)),
                rpId: location.hostname || 'localhost',
                allowCredentials: [{ id: this.base64URLToBuffer(stored.rawId), type: 'public-key', transports: ['internal'] }],
                userVerification: 'required', timeout: 60000
            };
            await navigator.credentials.get({ publicKey: options });
            return localStorage.getItem(this.ENCRYPTION_KEY_STORAGE);
        },
        reset() { localStorage.removeItem(this.CREDENTIAL_KEY); localStorage.removeItem(this.ENCRYPTION_KEY_STORAGE); }
    };

    // ========== åŠ å¯†æ¨¡å— ==========
    const CryptoModule = {
        async importKey(keyString) {
            const keyData = new TextEncoder().encode(keyString.padEnd(32, '0').substring(0, 32));
            return crypto.subtle.importKey('raw', keyData, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        },
        async encrypt(data, keyString) {
            const key = await this.importKey(keyString);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(JSON.stringify(data)));
            const result = new Uint8Array(iv.length + encrypted.byteLength);
            result.set(iv, 0); result.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...result));
        },
        async decrypt(encryptedBase64, keyString) {
            try {
                const key = await this.importKey(keyString);
                const data = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: data.slice(0, 12) }, key, data.slice(12));
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch { return null; }
        }
    };

    // ========== æ•°æ®æ¨¡å— ==========
    const DataModule = {
        NOTES_KEY: 'hazenote_encrypted_data',
        async save(notes, key) { localStorage.setItem(this.NOTES_KEY, await CryptoModule.encrypt(notes, key)); },
        async load(key) { const d = localStorage.getItem(this.NOTES_KEY); return d ? await CryptoModule.decrypt(d, key) || [] : []; }
    };

    const Session = {
        KEY: 'hazenote_session',
        get() { const s = sessionStorage.getItem(this.KEY); return s ? JSON.parse(s) : null; },
        set(key) { sessionStorage.setItem(this.KEY, JSON.stringify({ encryptionKey: key })); },
        clear() { sessionStorage.removeItem(this.KEY); }
    };

    // ========== åº”ç”¨çŠ¶æ€ ==========
    let notes = [];
    let currentWeather = '';
    let selectedColor = 'none';

    window.onload = async () => {
        if (!PasskeyModule.isSupported()) { showError('æµè§ˆå™¨ä¸æ”¯æŒ Passkey'); document.getElementById('passkeyBtn').disabled = true; return; }
        updateBtn();
        const s = Session.get(); if (s) await initApp(s.encryptionKey);
    };

    function updateBtn() { document.getElementById('passkeyBtnText').textContent = PasskeyModule.hasCredential() ? 'ä½¿ç”¨ Passkey è§£é”' : 'åˆ›å»º Passkey'; }
    function showError(msg) { const e = document.getElementById('loginError'); e.textContent = msg; e.classList.remove('hidden'); setTimeout(() => e.classList.add('hidden'), 5000); }

    async function handlePasskey() {
        const btn = document.getElementById('passkeyBtn'), txt = document.getElementById('passkeyBtnText');
        btn.disabled = true; const orig = txt.textContent; txt.textContent = 'éªŒè¯ä¸­...';
        try {
            const key = PasskeyModule.hasCredential() ? await PasskeyModule.authenticate() : await PasskeyModule.register();
            Session.set(key); await initApp(key);
        } catch (e) {
            if (e.message === 'NO_CREDENTIAL') { PasskeyModule.reset(); updateBtn(); showError('Passkey å·²å¤±æ•ˆï¼Œè¯·é‡æ–°åˆ›å»º'); }
            else showError(e.message || 'è®¤è¯å¤±è´¥');
        } finally { btn.disabled = false; txt.textContent = orig; updateBtn(); }
    }

    async function initApp(key) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        notes = await DataModule.load(key);
        mockWeather(); renderNotes();
        document.getElementById('noteInput').addEventListener('input', e => {
            document.getElementById('charCount').textContent = e.target.value.length + '/1000';
        });
    }

    function lockApp() { Session.clear(); notes = []; document.getElementById('mainApp').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); updateBtn(); }

    function mockWeather() {
        const temps = ['18Â°', '22Â°', '25Â°', '28Â°'];
        const temp = temps[Math.floor(Math.random() * temps.length)];
        currentWeather = new Date().toLocaleDateString() + ' | ' + temp;
        document.getElementById('headerDate').textContent = new Date().toLocaleDateString('zh-CN', { weekday: 'long' }) + ' âœ¦';
        document.getElementById('statWeather').textContent = temp;
        document.getElementById('modalWeather').textContent = currentWeather;
    }

    function updateStats() {
        document.getElementById('statCount').textContent = notes.length;
        document.getElementById('statChars').textContent = notes.reduce((s, n) => s + (n.content?.length || 0), 0);
        if (notes.length) {
            const min = Math.min(...notes.map(n => new Date(n.date).getTime()));
            document.getElementById('statDays').textContent = Math.max(1, Math.ceil((Date.now() - min) / 86400000));
        } else document.getElementById('statDays').textContent = 0;
    }

    function renderNotes() {
        const list = document.getElementById('noteList'); list.innerHTML = ''; updateStats();
        if (!notes.length) {
            list.innerHTML = `
                <div class="text-center mt-16">
                    <div class="w-16 h-16 mx-auto blob-purple opacity-20 mb-6"></div>
                    <p class="text-gray-600 text-base">è¿˜æ²¡æœ‰ä¾¿ç­¾</p>
                    <p class="text-gray-700 text-sm mt-2">ç‚¹å‡» + å¼€å§‹è®°å½• âœ¦</p>
                </div>`;
            return;
        }
        const order = { purple: 3, orange: 2, yellow: 1, none: 0 };
        [...notes].sort((a, b) => (order[b.color || 'none'] - order[a.color || 'none']) || new Date(b.date) - new Date(a.date)).forEach(n => {
            const el = document.createElement('div');
            const bgClass = n.color && n.color !== 'none' ? 'tagged-' + n.color : 'tagged-none';
            const textClass = n.color === 'yellow' ? 'text-dark' : 'text-white';
            el.className = 'note-card relative w-full mb-3 ' + bgClass;
            el.innerHTML = `
                <div class="swipe-actions">
                    <button onclick="event.stopPropagation();setColor('${n.id}','purple')" class="w-9 h-9 rounded-lg bg-purple flex items-center justify-center"><span class="text-sm">ğŸ’œ</span></button>
                    <button onclick="event.stopPropagation();setColor('${n.id}','orange')" class="w-9 h-9 rounded-lg bg-orange flex items-center justify-center"><span class="text-sm">ğŸ§¡</span></button>
                    <button onclick="event.stopPropagation();setColor('${n.id}','yellow')" class="w-9 h-9 rounded-lg bg-yellow flex items-center justify-center"><span class="text-sm">ğŸ’›</span></button>
                </div>
                <div class="card-inner p-4 rounded-[20px]" id="card-${n.id}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[11px] opacity-50">${n.weather?.split('|')[0]?.trim() || ''}</span>
                        <button onclick="event.stopPropagation();toggleSwipe('${n.id}')" class="opacity-40 hover:opacity-100 p-1 -mr-1"><i class="fa-solid fa-ellipsis text-xs"></i></button>
                    </div>
                    <p class="${textClass} text-[15px] leading-relaxed line-clamp-4 font-serif">${n.content}</p>
                    <div class="mt-3 pt-2 border-t border-white/10 flex justify-between items-center">
                        <span class="text-[11px] opacity-30">${n.weather?.split('|')[1]?.trim() || ''}</span>
                        <div class="flex gap-4">
                            <button onclick="event.stopPropagation();deleteNote('${n.id}')" class="opacity-30 hover:opacity-100 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                            <button onclick="event.stopPropagation();prepareShare('${n.id}')" class="opacity-30 hover:opacity-100 transition"><i class="fa-solid fa-share text-xs"></i></button>
                        </div>
                    </div>
                </div>`;
            const inner = el.querySelector('.card-inner');
            inner.addEventListener('touchstart', e => { el._sx = e.touches[0].clientX; el._sy = e.touches[0].clientY; }, { passive: true });
            inner.addEventListener('touchend', e => {
                const dx = el._sx - e.changedTouches[0].clientX;
                const dy = Math.abs(el._sy - e.changedTouches[0].clientY);
                if (Math.abs(dx) > 50 && dy < 30) {
                    document.querySelectorAll('.note-card.swiped').forEach(c => c !== el && c.classList.remove('swiped'));
                    el.classList.toggle('swiped', dx > 0);
                }
            }, { passive: true });
            list.appendChild(el);
        });
    }

    function toggleSwipe(id) {
        const el = document.getElementById('card-' + id).parentElement;
        document.querySelectorAll('.note-card.swiped').forEach(c => c !== el && c.classList.remove('swiped'));
        el.classList.toggle('swiped');
    }

    async function setColor(id, color) {
        const n = notes.find(x => x.id === id);
        if (n) { n.color = n.color === color ? 'none' : color; await DataModule.save(notes, Session.get().encryptionKey); renderNotes(); }
    }

    function selectColor(color) {
        selectedColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-card'));
        event.target.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-card');
    }

    function openNewNoteModal() {
        document.getElementById('noteInput').value = '';
        document.getElementById('charCount').textContent = '0/1000';
        selectedColor = 'none';
        document.querySelectorAll('.color-btn').forEach((b, i) => {
            b.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-card');
            if (i === 0) b.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-card');
        });
        document.getElementById('noteModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('noteInput').focus(), 100);
    }
    function closeModal() { document.getElementById('noteModal').classList.add('hidden'); }

    async function saveNote() {
        const c = document.getElementById('noteInput').value;
        if (!c.trim()) return;
        notes.unshift({ id: Date.now().toString(), content: c, date: new Date().toISOString(), weather: currentWeather, color: selectedColor });
        await DataModule.save(notes, Session.get().encryptionKey);
        renderNotes(); closeModal();
    }

    async function deleteNote(id) {
        if (confirm('ç¡®å®šåˆ é™¤?')) {
            notes = notes.filter(n => n.id !== id);
            await DataModule.save(notes, Session.get().encryptionKey);
            renderNotes();
        }
    }

    async function exportData() {
        const d = { app: 'HazeNote', version: '2.0', notes };
        const a = document.createElement('a');
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(d, null, 2));
        a.download = 'hazenote_backup.json'; a.click();
    }
    function triggerImport() { document.getElementById('fileInput').click(); }
    async function importData(input) {
        const f = input.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = async e => {
            try {
                const d = JSON.parse(e.target.result);
                if (d.app === 'HazeNote') {
                    notes = [...d.notes, ...notes].filter((n, i, a) => a.findIndex(x => x.id === n.id) === i);
                    await DataModule.save(notes, Session.get().encryptionKey);
                    renderNotes(); alert('å¯¼å…¥æˆåŠŸ âœ¦');
                }
            } catch { alert('å¯¼å…¥å¤±è´¥'); }
        };
        r.readAsText(f);
    }

    // ========== åˆ†äº«åŠŸèƒ½ ==========
    function prepareShare(id) {
        const n = notes.find(x => x.id === id); if (!n) return;
        const d = new Date(n.date);
        document.getElementById('shareText').textContent = n.content;
        document.getElementById('shareFooterInfo').textContent = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
        document.getElementById('shareWeatherSmall').textContent = n.weather?.split('|')[1]?.trim() || '';
        const colors = { purple: '#7B61FF', orange: '#FF6B4A', yellow: '#D4A853' };
        document.getElementById('shareAccentColor').textContent = colors[n.color] || '#7B61FF';
        drawShareCard(); document.getElementById('sharePreviewOverlay').classList.remove('hidden');
    }

    function drawShareCard() {
        const canvas = document.getElementById('shareCanvas'), ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const content = document.getElementById('shareText').textContent;
        const date = document.getElementById('shareFooterInfo').textContent;
        const weather = document.getElementById('shareWeatherSmall').textContent;
        const color = document.getElementById('shareAccentColor').textContent;

        ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0, 0, W, H);

        // è£…é¥°
        ctx.fillStyle = color; ctx.globalAlpha = 0.25;
        ctx.beginPath(); ctx.ellipse(W - 80, 120, 180, 150, 0, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#FF6B4A'; ctx.globalAlpha = 0.2;
        ctx.beginPath(); ctx.ellipse(W - 180, 200, 90, 80, 0.3, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1;

        ctx.fillStyle = color; ctx.fillRect(0, 0, W, 5);

        ctx.font = 'bold 44px Inter, sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.fillText('HazeNote', 60, 100);

        ctx.font = '26px Inter, sans-serif';
        ctx.fillStyle = '#555';
        ctx.textAlign = 'right';
        ctx.fillText(weather, W - 60, 100);
        ctx.textAlign = 'left';

        ctx.font = '500 42px "Noto Serif SC", Georgia, serif';
        ctx.fillStyle = '#ffffff';
        let y = 200, lines = [], line = '';
        for (const c of content) {
            if (c === '\n' || ctx.measureText(line + c).width > W - 120) {
                lines.push(line); line = c === '\n' ? '' : c;
            } else line += c;
        }
        if (line) lines.push(line);
        lines.slice(0, 6).forEach((l, i) => ctx.fillText(l, 60, y + i * 66));

        ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(60, H - 90); ctx.lineTo(W - 60, H - 90); ctx.stroke();
        ctx.font = '22px Inter, sans-serif';
        ctx.fillStyle = '#444';
        ctx.fillText(date, 60, H - 45);

        // æ˜Ÿæ˜Ÿ
        ctx.fillStyle = color; ctx.globalAlpha = 0.5;
        ctx.font = '24px serif';
        ctx.fillText('âœ¦', W - 80, H - 45);
        ctx.globalAlpha = 1;
    }

    function closeShare() { document.getElementById('sharePreviewOverlay').classList.add('hidden'); }
    async function downloadImage() {
        const canvas = document.getElementById('shareCanvas');
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'HazeNote_' + Date.now() + '.png';
        a.click();
    }
    async function shareNative() {
        try {
            const canvas = document.getElementById('shareCanvas');
            const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
            const file = new File([blob], 'HazeNote.png', { type: 'image/png' });
            if (navigator.canShare?.({ files: [file] })) await navigator.share({ files: [file], title: 'HazeNote' });
            else await downloadImage();
        } catch { await downloadImage(); }
    }
    </script>
</body>
</html>
