<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazeNote V3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        dark: '#111111',
                        teal: '#85B9C9',
                        peach: '#FFBE9D',
                        purple: '#A29BFE',
                        orange: '#FF6B4A',
                        danger: '#FF4A4A',
                    },
                    fontFamily: {
                        sans: ['Urbanist', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { 
            background-color: #000000; 
            color: white; 
            font-family: 'Urbanist', sans-serif;
            overscroll-behavior: none; 
            user-select: none;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* èƒŒæ™¯å…‰æ™• */
        .blob-bg {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: 0;
            opacity: 0.4;
            pointer-events: none;
        }

        /* æœç´¢æ¡†åŠ¨ç”» */
        .search-bar-enter { animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .search-bar-exit { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideDown { from { height: 0; opacity: 0; margin-bottom: 0; } to { height: 50px; opacity: 1; margin-bottom: 20px; } }
        @keyframes slideUp { from { height: 50px; opacity: 1; margin-bottom: 20px; } to { height: 0; opacity: 0; margin-bottom: 0; } }

        /* æ»‘åŠ¨æ“ä½œæ ·å¼ */
        .note-container {
            position: relative;
            overflow: hidden;
            border-radius: 32px;
            margin-bottom: 1rem;
        }
        .note-card-content {
            position: relative;
            z-index: 10;
            background: #111111; /* fallback */
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            touch-action: pan-y; /* å…è®¸å‚ç›´æ»šåŠ¨ï¼Œæ¥ç®¡æ°´å¹³ */
        }
        .note-actions {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-right: 20px;
            gap: 12px;
            background: #1a1a1a;
            z-index: 1;
            border-radius: 32px;
        }
        
        /* Assistive Button Ring Animation */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* èœå•åŠ¨ç”» */
        .menu-enter { animation: menuPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes menuPop { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Pinned Style */
        .pinned-glow {
            box-shadow: 0 0 0 2px #85B9C9, 0 0 20px rgba(133, 185, 201, 0.3);
        }

        textarea:focus { outline: none; }
    </style>
</head>
<body class="flex justify-center min-h-screen overflow-hidden bg-black">

    <div class="blob-bg w-80 h-80 bg-teal/20 top-[-10%] left-[-10%]"></div>
    <div class="blob-bg w-96 h-96 bg-purple/20 bottom-[-10%] right-[-10%]"></div>

    <div id="mainApp" class="w-full max-w-md h-screen flex flex-col relative z-10 bg-black/50 backdrop-blur-sm">
        
        <header class="px-6 pt-14 pb-2 z-20">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-teal to-purple p-[2px]">
                        <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Haze" class="w-full h-full rounded-full bg-black">
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 font-medium">Welcome back</p>
                        <h1 class="text-2xl font-bold text-white tracking-tight">HazeNote</h1>
                    </div>
                </div>
                <button onclick="toggleSearch()" class="w-10 h-10 rounded-full bg-dark border border-white/10 flex items-center justify-center text-gray-400 hover:text-white transition">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>

            <div id="searchContainer" class="hidden overflow-hidden">
                <div class="bg-dark border border-white/10 rounded-2xl h-full flex items-center px-4">
                    <i class="fa-solid fa-filter text-teal mr-3"></i>
                    <input id="searchInput" type="text" placeholder="Search keyword..." class="bg-transparent w-full text-white placeholder-gray-600 outline-none h-12" oninput="handleSearch(this.value)">
                    <button onclick="toggleSearch()" class="text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <div class="flex justify-between items-end mt-2">
                <h2 id="viewTitle" class="text-4xl font-bold text-white leading-none">My<br/>Notes</h2>
                <div class="flex gap-2">
                    <span id="pinCountBadge" class="text-xs bg-purple/20 text-purple px-2 py-1 rounded-lg border border-purple/20 hidden">ğŸ“Œ 0/3</span>
                    <div class="bg-dark border border-white/10 px-3 py-1 rounded-full text-xs text-gray-400 font-mono" id="noteCount">0 Notes</div>
                </div>
            </div>
        </header>

        <main id="noteList" class="flex-1 overflow-y-auto px-5 pb-32 pt-4 no-scrollbar">
            </main>

        <div class="fixed bottom-10 left-0 right-0 flex justify-center z-50 pointer-events-none">
            <div class="relative pointer-events-auto">
                <div id="assistiveMenu" class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-[#1A1A1A]/90 backdrop-blur-xl border border-white/10 rounded-2xl p-2 w-48 shadow-2xl hidden flex-col gap-1 origin-bottom">
                    <button onclick="changeView('list')" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                        <i class="fa-solid fa-list text-teal w-5"></i> <span>List View</span>
                    </button>
                    <button onclick="changeView('grid')" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                        <i class="fa-solid fa-border-all text-purple w-5"></i> <span>Module View</span>
                    </button>
                    <div class="h-px bg-white/10 my-1"></div>
                    <button onclick="triggerImport()" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                        <i class="fa-solid fa-file-import text-gray-500 w-5"></i> <span>Import</span>
                    </button>
                    <button onclick="exportData()" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/10 text-gray-300 hover:text-white transition w-full text-left">
                        <i class="fa-solid fa-file-export text-gray-500 w-5"></i> <span>Export</span>
                    </button>
                </div>

                <div class="relative w-16 h-16 flex items-center justify-center">
                    <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" width="64" height="64">
                        <circle class="progress-ring__circle" stroke="#85B9C9" stroke-width="4" fill="transparent" r="28" cx="32" cy="32" 
                                style="stroke-dasharray: 175.9; stroke-dashoffset: 175.9;"/>
                    </svg>
                    
                    <button id="assistiveBtn" class="w-14 h-14 rounded-full bg-teal text-black text-2xl flex items-center justify-center shadow-[0_0_20px_rgba(133,185,201,0.4)] active:scale-90 transition-transform z-10">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col">
        <div class="px-6 pt-14 pb-4 flex justify-between items-center">
            <button onclick="closeModal()" class="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center text-white hover:bg-white/10">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <span class="text-sm font-bold text-gray-500 tracking-wider">NEW NOTE</span>
            <button onclick="saveNote()" class="w-12 h-12 rounded-full bg-teal text-black flex items-center justify-center font-bold hover:scale-105 transition">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>
        <div class="flex-1 px-8 pt-4">
            <textarea id="noteInput" class="w-full h-full bg-transparent text-white text-2xl font-medium placeholder-gray-700 resize-none leading-relaxed" placeholder="Type your thought..."></textarea>
        </div>
        <div class="px-8 pb-10 flex gap-4">
            <button onclick="setColor('dark')" class="color-btn w-8 h-8 rounded-full bg-[#111111] border border-white/20 ring-2 ring-white ring-offset-2 ring-offset-black"></button>
            <button onclick="setColor('teal')" class="color-btn w-8 h-8 rounded-full bg-teal"></button>
            <button onclick="setColor('orange')" class="color-btn w-8 h-8 rounded-full bg-orange"></button>
            <button onclick="setColor('light')" class="color-btn w-8 h-8 rounded-full bg-[#F6F6F6]"></button>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">

    <script>
        // ========== çŠ¶æ€ç®¡ç† ==========
        const CONFIG = {
            PIN_LIMIT: 3,
            LONG_PRESS_MS: 3000 // 3ç§’é•¿æŒ‰
        };

        let state = {
            notes: [],
            viewMode: localStorage.getItem('haze_view_mode') || 'grid', // 'grid' | 'list'
            searchQuery: '',
            isSearchOpen: false,
            editingColor: 'dark',
            pressTimer: null,
            startTime: 0
        };

        // ========== åˆå§‹åŒ– ==========
        window.onload = () => {
            loadNotes();
            setupAssistiveTouch();
        };

        function loadNotes() {
            const saved = localStorage.getItem('haze_notes_v3');
            if (saved) {
                state.notes = JSON.parse(saved);
            }
            renderNotes();
        }

        function saveToLocal() {
            localStorage.setItem('haze_notes_v3', JSON.stringify(state.notes));
            localStorage.setItem('haze_view_mode', state.viewMode);
            renderNotes();
        }

        // ========== è§†å›¾ä¸æœç´¢ ==========
        function changeView(mode) {
            state.viewMode = mode;
            saveToLocal(); // ä¿å­˜è§†å›¾åå¥½
            document.getElementById('assistiveMenu').classList.remove('menu-enter');
            setTimeout(() => document.getElementById('assistiveMenu').classList.add('hidden'), 200);
        }

        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            state.isSearchOpen = !state.isSearchOpen;
            
            if (state.isSearchOpen) {
                container.classList.remove('hidden');
                container.classList.remove('search-bar-exit');
                container.classList.add('search-bar-enter');
                document.getElementById('searchInput').focus();
            } else {
                container.classList.remove('search-bar-enter');
                container.classList.add('search-bar-exit');
                setTimeout(() => container.classList.add('hidden'), 300);
                state.searchQuery = '';
                document.getElementById('searchInput').value = '';
                renderNotes();
            }
        }

        function handleSearch(val) {
            state.searchQuery = val.toLowerCase();
            renderNotes();
        }

        // ========== æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ==========
        function renderNotes() {
            const list = document.getElementById('noteList');
            const noteCountEl = document.getElementById('noteCount');
            const pinBadge = document.getElementById('pinCountBadge');
            
            // 1. è¿‡æ»¤
            let displayNotes = state.notes.filter(n => n.content.toLowerCase().includes(state.searchQuery));
            
            // 2. æ’åºï¼šç½®é¡¶ä¼˜å…ˆ -> æ—¥æœŸå€’åº
            displayNotes.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                return new Date(b.date) - new Date(a.date);
            });

            // æ›´æ–° UI è®¡æ•°
            noteCountEl.innerText = `${displayNotes.length} Notes`;
            const pinnedCount = state.notes.filter(n => n.isPinned).length;
            if (pinnedCount > 0) {
                pinBadge.classList.remove('hidden');
                pinBadge.innerText = `ğŸ“Œ ${pinnedCount}/${CONFIG.PIN_LIMIT}`;
            } else {
                pinBadge.classList.add('hidden');
            }

            // 3. æ„å»º HTML
            list.innerHTML = '';
            
            if (displayNotes.length === 0) {
                list.innerHTML = `<div class="text-center mt-20 text-gray-600">No notes found.</div>`;
                return;
            }

            if (state.viewMode === 'list') {
                // åˆ—è¡¨æ¨¡å¼ï¼šç»Ÿä¸€é«˜åº¦ï¼Œç´§å‡‘
                displayNotes.forEach(note => {
                    list.innerHTML += createNoteCard(note, 'list');
                });
            } else {
                // æ¨¡å—æ¨¡å¼ (Grid/Bento)
                // ç¬¬ä¸€å¼ æ˜¾ç¤ºå¤§å¡ç‰‡ï¼Œå…¶ä½™æ ¹æ®é¢œè‰²æˆ–ç´¢å¼•æ˜¾ç¤ºä¸åŒæ ·å¼
                displayNotes.forEach((note, index) => {
                    let style = 'dark-simple';
                    if (index === 0 && !state.searchQuery) style = 'large-hero'; // åªæœ‰éæœç´¢çŠ¶æ€ç¬¬ä¸€ä¸ªæ‰å¤§
                    else if (note.color === 'orange') style = 'orange-typo';
                    else if (note.color === 'teal') style = 'teal-block';
                    else if (note.color === 'light') style = 'light-clean';
                    
                    list.innerHTML += createNoteCard(note, style);
                });
            }

            // 4. ç»‘å®šæ‰‹åŠ¿äº‹ä»¶
            bindSwipeEvents();
        }

        function createNoteCard(note, styleType) {
            const dateStr = new Date(note.date).toLocaleDateString('en', { month: 'short', day: 'numeric' });
            const isPinnedClass = note.isPinned ? 'pinned-glow' : '';
            const pinIcon = note.isPinned ? '<i class="fa-solid fa-thumbtack text-teal absolute top-4 right-4 z-20"></i>' : '';

            // å†…éƒ¨ HTML ç»“æ„ç”Ÿæˆ
            let innerHTML = '';
            let wrapperClass = `note-card-content w-full rounded-[32px] p-6 relative z-10 overflow-hidden border border-white/5 ${isPinnedClass} `;

            // æ ·å¼å®šä¹‰
            if (styleType === 'list') {
                wrapperClass += `bg-[#1A1A1A] min-h-[100px] flex items-center justify-between`;
                innerHTML = `
                    <div class="flex-1 pr-4">
                        <p class="text-gray-200 font-medium line-clamp-1 text-lg">${note.content}</p>
                        <span class="text-xs text-gray-500 mt-1 block">${dateStr}</span>
                    </div>
                    ${note.isPinned ? '<i class="fa-solid fa-thumbtack text-teal text-sm"></i>' : ''}
                `;
            } else if (styleType === 'large-hero') {
                wrapperClass += `bg-[#111111] min-h-[200px] flex flex-col justify-between`;
                innerHTML = `
                    ${pinIcon}
                    <div class="mt-2"><span class="bg-teal text-black text-xs font-bold px-2 py-1 rounded">TODAY</span></div>
                    <p class="text-2xl font-bold text-gray-100 line-clamp-4 mt-4">${note.content}</p>
                    <div class="mt-4 text-xs text-gray-500 font-mono text-right">${dateStr}</div>
                `;
            } else if (styleType === 'orange-typo') {
                wrapperClass += `bg-orange text-black min-h-[160px] flex items-center justify-center text-center`;
                innerHTML = `
                    ${note.isPinned ? '<i class="fa-solid fa-thumbtack text-black absolute top-4 right-4 z-20 opacity-50"></i>' : ''}
                    <p class="text-4xl font-black uppercase leading-none break-all line-clamp-3">${note.content}</p>
                    <span class="absolute bottom-3 right-5 text-xs font-bold opacity-60">${dateStr}</span>
                `;
            } else if (styleType === 'teal-block') {
                wrapperClass += `bg-teal text-black min-h-[140px]`;
                innerHTML = `
                    ${note.isPinned ? '<i class="fa-solid fa-thumbtack text-black absolute top-4 right-4 z-20 opacity-50"></i>' : ''}
                    <p class="text-lg font-bold leading-tight line-clamp-4">${note.content}</p>
                    <div class="mt-4 pt-2 border-t border-black/10 text-xs font-bold opacity-60 flex justify-between">
                        <span>Memo</span><span>${dateStr}</span>
                    </div>
                `;
            } else if (styleType === 'light-clean') {
                wrapperClass += `bg-[#F6F6F6] text-black min-h-[140px]`;
                innerHTML = `
                    ${note.isPinned ? '<i class="fa-solid fa-thumbtack text-gray-400 absolute top-4 right-4 z-20"></i>' : ''}
                    <h3 class="text-sm font-bold text-gray-400 mb-2">NOTE</h3>
                    <p class="text-gray-800 font-medium line-clamp-3">${note.content}</p>
                `;
            } else {
                // dark-simple
                wrapperClass += `bg-[#1A1A1A] min-h-[140px]`;
                innerHTML = `
                    ${pinIcon}
                    <p class="text-gray-300 font-medium line-clamp-3 mb-6">${note.content}</p>
                    <span class="absolute bottom-4 right-6 text-xs text-gray-600 font-bold tracking-widest">${dateStr}</span>
                `;
            }

            // è¿”å›å®Œæ•´çš„å¯æ»‘åŠ¨ç»“æ„
            return `
            <div class="note-container" data-id="${note.id}">
                <div class="note-actions">
                    <button onclick="togglePin('${note.id}')" class="w-10 h-10 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-white transition">
                        <i class="fa-solid fa-thumbtack ${note.isPinned ? 'text-teal' : ''}"></i>
                    </button>
                    <button onclick="shareNote('${note.id}')" class="w-10 h-10 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-white transition">
                        <i class="fa-solid fa-bolt"></i>
                    </button>
                    <button onclick="confirmDelete('${note.id}')" class="w-10 h-10 rounded-full bg-danger/20 flex items-center justify-center text-danger hover:bg-danger hover:text-white transition">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <div class="${wrapperClass}" id="card-${note.id}">
                    ${innerHTML}
                </div>
            </div>`;
        }

        // ========== AssistiveTouch é€»è¾‘ (3ç§’é•¿æŒ‰) ==========
        function setupAssistiveTouch() {
            const btn = document.getElementById('assistiveBtn');
            const ring = document.querySelector('.progress-ring__circle');
            const menu = document.getElementById('assistiveMenu');
            const radius = ring.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;

            ring.style.strokeDasharray = `${circumference} ${circumference}`;
            ring.style.strokeDashoffset = circumference;

            let timer;
            let isLongPress = false;

            const startPress = (e) => {
                // e.preventDefault(); // é˜²æ­¢æ»šåŠ¨å¹²æ‰°? ä¸è¦é˜»æ­¢ï¼Œå¦åˆ™æ— æ³•ç‚¹å‡»
                isLongPress = false;
                menu.classList.remove('menu-enter');
                menu.classList.add('hidden');
                
                ring.style.transition = `stroke-dashoffset ${CONFIG.LONG_PRESS_MS}ms linear`;
                ring.style.strokeDashoffset = '0'; // å¼€å§‹è½¬åœˆ

                timer = setTimeout(() => {
                    isLongPress = true;
                    // é•¿æŒ‰è§¦å‘
                    if(navigator.vibrate) navigator.vibrate(50);
                    menu.classList.remove('hidden');
                    menu.classList.add('menu-enter');
                    ring.style.transition = 'none'; // reset ring
                    ring.style.strokeDashoffset = circumference;
                }, CONFIG.LONG_PRESS_MS);
            };

            const endPress = (e) => {
                clearTimeout(timer);
                ring.style.transition = 'stroke-dashoffset 0.2s ease-out';
                ring.style.strokeDashoffset = circumference; // å›é€€

                if (!isLongPress) {
                    // çŸ­æŒ‰ï¼šæ–°å»ºç¬”è®°
                    openNewNoteModal();
                }
            };

            // Touch events for mobile
            btn.addEventListener('touchstart', startPress, {passive: true});
            btn.addEventListener('touchend', endPress);
            
            // Mouse events for desktop testing
            btn.addEventListener('mousedown', startPress);
            btn.addEventListener('mouseup', endPress);
        }

        // ========== æ‰‹åŠ¿ (Swipe) é€»è¾‘ ==========
        function bindSwipeEvents() {
            document.querySelectorAll('.note-container').forEach(el => {
                const card = el.querySelector('.note-card-content');
                let startX, currentX;
                let isSwiping = false;

                card.addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX;
                    isSwiping = false;
                    // é‡ç½®å…¶ä»–å·²æ‰“å¼€çš„å¡ç‰‡
                    document.querySelectorAll('.note-card-content').forEach(c => {
                        if(c !== card) c.style.transform = `translateX(0)`;
                    });
                }, {passive: true});

                card.addEventListener('touchmove', e => {
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    // åªèƒ½å‘å·¦æ»‘
                    if (diff < 0 && diff > -180) { 
                        card.style.transform = `translateX(${diff}px)`;
                        isSwiping = true;
                    }
                }, {passive: true});

                card.addEventListener('touchend', e => {
                    const diff = currentX - startX;
                    if (diff < -80) { // é˜ˆå€¼ï¼Œè¶…è¿‡å±•å¼€
                        card.style.transform = `translateX(-160px)`;
                    } else {
                        card.style.transform = `translateX(0)`;
                    }
                });
            });
        }

        // ========== ç¬”è®°æ“ä½œ ==========
        
        // é¢œè‰²é€‰æ‹©
        function setColor(c) {
            state.editingColor = c;
            document.querySelectorAll('.color-btn').forEach(b => {
                b.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black');
            });
            event.target.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black');
        }

        function openNewNoteModal() {
            document.getElementById('noteInput').value = '';
            setColor('dark');
            document.getElementById('noteModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('noteInput').focus(), 100);
        }

        function closeModal() {
            document.getElementById('noteModal').classList.add('hidden');
        }

        function saveNote() {
            const content = document.getElementById('noteInput').value.trim();
            if (!content) return closeModal();

            const newNote = {
                id: Date.now().toString(),
                content: content,
                date: new Date().toISOString(),
                color: state.editingColor,
                isPinned: false
            };
            
            state.notes.unshift(newNote);
            saveToLocal();
            closeModal();
        }

        function togglePin(id) {
            const note = state.notes.find(n => n.id === id);
            if (!note) return;

            const currentPins = state.notes.filter(n => n.isPinned).length;

            if (note.isPinned) {
                note.isPinned = false;
            } else {
                if (currentPins >= CONFIG.PIN_LIMIT) {
                    alert(`Max ${CONFIG.PIN_LIMIT} pinned notes allowed.`);
                    return;
                }
                note.isPinned = true;
            }
            saveToLocal();
        }

        function confirmDelete(id) {
            if (confirm("Are you sure you want to delete this note?")) {
                state.notes = state.notes.filter(n => n.id !== id);
                saveToLocal();
            }
        }

        function shareNote(id) {
            const note = state.notes.find(n => n.id === id);
            if (navigator.share) {
                navigator.share({
                    title: 'HazeNote',
                    text: note.content
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(note.content).then(() => alert('Copied to clipboard'));
            }
        }

        // ========== æ•°æ® I/O ==========
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.notes));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = `HazeNote_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function triggerImport() {
            document.getElementById('fileInput').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        // Merge strategies: Keep unique IDs
                        const existingIds = new Set(state.notes.map(n => n.id));
                        const newNotes = imported.filter(n => !existingIds.has(n.id));
                        state.notes = [...newNotes, ...state.notes];
                        saveToLocal();
                        alert(`Imported ${newNotes.length} notes.`);
                    }
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>
